<div class="flex gap-1 sm:gap-2">
  <button
    type="button"
    labButton
    [faIcon]="faTableColumns"
    text="columns.header"
    (click)="columns.open()"
  ></button>
  @if (objectivesStore.steps().length) {
    <button
      type="button"
      labButton
      [faIcon]="faFileArrowDown"
      text="steps.downloadAsCsv"
      (click)="exporter.stepsToCsv(objectivesStore.steps())"
    ></button>
  }
</div>

<table class="table">
  <thead>
    <tr>
      <!-- Row Actions -->
      <th class="w-0"></th>
      <!-- Checkbox -->
      @if (cols().checkbox.show) {
        <th class="w-0">
          <div class="flex">
            @let disabled =
              !settings().checkedItemIds.size &&
              !settings().checkedRecipeIds.size &&
              !settings().checkedObjectiveIds.size;
            <button
              type="button"
              labButton
              [attr.aria-label]="'steps.checkedUndoTooltip' | translate"
              [faIcon]="disabled ? faSquareCheck : faRotateLeft"
              [labTooltip]="disabled ? '' : 'steps.checkedUndoTooltip'"
              [disabled]="disabled"
              [border]="!disabled"
              (click)="resetChecked()"
            ></button>
          </div>
        </th>
      }
      <!-- Tree -->
      @if (!focus() && cols().tree.show) {
        <th>{{ 'options.column.tree' | translate }}</th>
      }
      <!-- Items (Surplus, Value, & Icon) -->
      <th
        colspan="3"
        labSortHeader
        column="items"
        [text]="displayRateInfo().itemsLabel"
        [showUndo]="!!settings().excludedItemIds.size"
        undoTooltip="steps.itemsUndoTooltip"
        (undo)="resetExcludedItems()"
      ></th>
      <!-- Belts (Value & Icon) -->
      @if (cols().belts.show) {
        <th
          colspan="2"
          labSortHeader
          column="belts"
          text="options.column.belts"
          [showUndo]="itemsStore.itemsModified().belts"
          undoTooltip="steps.beltsUndoTooltip"
          (undo)="itemsStore.resetFields('beltId', 'stack')"
        ></th>
      }
      <!-- Wagons (Value & Icon) -->
      @if (cols().wagons.show) {
        <th
          colspan="2"
          labSortHeader
          column="wagons"
          [text]="displayRateInfo().wagonsLabel"
          [showUndo]="itemsStore.itemsModified().wagons"
          undoTooltip="steps.wagonsUndoTooltip"
          (undo)="itemsStore.resetFields('wagonId')"
        ></th>
      }
      <!-- Rockets (Value & Icon) -->
      @if (cols().rockets.show) {
        <th
          colspan="2"
          labSortHeader
          column="rockets"
          [text]="displayRateInfo().rocketsLabel"
        ></th>
      }
      <!-- Machines (Value & Icon) -->
      <th
        colspan="2"
        labSortHeader
        column="machines"
        text="options.column.machines"
        [showUndo]="objectivesStore.recipesModified().machines"
        undoTooltip="steps.machinesUndoTooltip"
        (undo)="resetMachines()"
      ></th>
      <!-- Beacons -->
      @if (cols().beacons.show) {
        <th>
          <div class="flex items-center gap-2">
            <span>{{ 'options.column.beacons' | translate }}</span>
            @if (objectivesStore.recipesModified().beacons) {
              <button
                type="button"
                class="ms-auto"
                labButton
                [attr.aria-label]="'steps.beaconsUndoTooltip' | translate"
                labTooltip="steps.beaconsUndoTooltip"
                labTooltipPosition="adjacent"
                [faIcon]="faArrowRotateLeft"
                (click)="resetBeacons()"
              ></button>
            }
          </div>
        </th>
      }
      <!-- Power -->
      @if (cols().power.show) {
        <th labSortHeader column="power" text="options.column.power"></th>
      }
      <!-- Pollution -->
      @if (cols().pollution.show) {
        <th
          labSortHeader
          column="pollution"
          [text]="displayRateInfo().pollutionLabel"
        ></th>
      }
      <!-- Link -->
      @if (cols().link.show) {
        <th class="w-0"></th>
      }
    </tr>
  </thead>
  <tbody>
    @for (step of sortedSteps(); track step.id) {
      @let expanded = expandedSteps().has(step.id);
      <tr>
        <!-- Row Actions -->
        <td>
          @let stepId = 'step_' + step.id;
          <div [id]="stepId" class="hidden"></div>
          @for (
            item of objectivesStore.stepDetails()[step.id].tabs;
            track item.label
          ) {
            <div [id]="stepId + '_' + item.label" class="hidden"></div>
          }
          <div class="flex">
            @let tooltip = expanded ? 'steps.hideDetails' : 'steps.showDetails';
            <button
              type="button"
              class="*:transition-transform"
              [class.*:rotate-90]="expanded"
              labButton
              [faIcon]="faAngleRight"
              [border]="false"
              [attr.aria-label]="tooltip | translate"
              [labTooltip]="tooltip"
              labTooltipPosition="adjacent"
              (click)="toggleStep(step)"
            ></button>
          </div>
        </td>
        <!-- Checkbox -->
        @if (cols().checkbox.show) {
          <td>
            <div class="flex justify-center">
              <lab-checkbox
                [ngModel]="step.checked"
                (ngModelChange)="changeStepChecked(step, $event)"
              ></lab-checkbox>
            </div>
          </td>
        }
        <!-- Tree -->
        @if (!focus() && cols().tree.show) {
          <td class="px-0 py-0 sm:px-2">
            <div class="flex h-12 items-center">
              @let _tree = objectivesStore.stepTree()[step.id];
              @if (sort() == null && _tree.length) {
                @for (trail of _tree; track $index) {
                  <div
                    class="mb-6 self-end border-dotted border-gray-50"
                    [class]="{
                      'border-e-2': trail || $last,
                      'ms-2': $first,
                      'ms-4': !$first,
                      'sm:ms-4.5': $first,
                      'sm:ms-6': !$first,
                      'h-12.5': trail || $last,
                    }"
                  ></div>
                }
                <div class="w-2 border-t-2 border-dotted border-gray-50"></div>
              }
              <div class="z-1 flex flex-col items-center">
                @if (step.itemId && step.recipeObjectiveId == null) {
                  <lab-exclude-button
                    [itemId]="step.itemId"
                  ></lab-exclude-button>
                } @else if (step.recipeId) {
                  <lab-icon
                    [value]="step.recipeId"
                    type="recipe"
                    [text]="'#' + step.recipeObjectiveId"
                    [labTooltip]="step.recipeId"
                    labTooltipType="recipe"
                    labTooltipPosition="adjacent"
                    [labTooltipAdjustedRecipe]="step.recipe"
                  ></lab-icon>
                }
              </div>
            </div>
          </td>
        }
        <!-- Items (Value & Icon) -->
        <td>
          @if (step.surplus) {
            <div
              class="text-brand-400 flex justify-end font-mono whitespace-pre"
            >
              (+{{ step.surplus | rate: cols().items.precision }})
            </div>
          }
        </td>
        <td class="w-0 pe-0">
          @if (step.items) {
            <div
              class="flex justify-end font-mono whitespace-pre"
              [innerHTML]="step.items | rate: cols().items.precision"
            ></div>
          }
        </td>
        <td class="ps-0">
          @if (step.itemId) {
            <div class="relative flex">
              <span
                class="absolute top-1 -z-1 text-transparent select-none"
                aria-hidden="true"
                >{{ data().itemRecord[step.itemId].name }}</span
              >
              <lab-exclude-button [itemId]="step.itemId"></lab-exclude-button>
            </div>
          }
        </td>
        <!-- Belts (Value & Icon) -->
        @if (cols().belts.show) {
          <td>
            @if (step.belts) {
              <div class="flex justify-end font-mono whitespace-pre">
                {{ step.belts | rate: cols().belts.precision }}
              </div>
            }
          </td>
          <td>
            @if (
              step.itemId && itemsStore.settings()[step.itemId];
              as itemSettings
            ) {
              @if (itemSettings.beltId; as beltId) {
                <div class="flex items-center">
                  @if (
                    data().beltIds.includes(beltId)
                      ? 'belt'
                      : data().pipeIds.includes(beltId)
                        ? 'pipe'
                        : null;
                    as type
                  ) {
                    @let stack = data().itemRecord[step.itemId].stack;
                    @if (
                      data().flags.has('beltStack') &&
                      stack &&
                      stack.gt(rational.one)
                    ) {
                      <lab-belt-select
                        [stack]="stack"
                        [labTooltip]="itemSettings.beltId"
                        labTooltipType="belt"
                        labTooltipAction="steps.beltSelectTooltip"
                        labTooltipPosition="adjacent"
                        [value]="itemSettings"
                        (valueChange)="changeBelts(step, $event)"
                      ></lab-belt-select>
                    } @else {
                      <lab-select
                        [iconOnly]="true"
                        [border]="false"
                        [options]="
                          settingsStore.options()[
                            type === 'belt' ? 'belts' : 'pipes'
                          ]
                        "
                        [labTooltip]="beltId"
                        labTooltipType="belt"
                        labTooltipAction="steps.beltTooltip"
                        labTooltipPosition="adjacent"
                        [ngModel]="beltId"
                        (ngModelChange)="
                          itemsStore.updateRecordField(
                            step.itemId,
                            'beltId',
                            $event,
                            itemSettings.defaultBeltId
                          )
                        "
                      ></lab-select>
                    }
                  } @else {
                    <lab-icon
                      [value]="beltId"
                      type="item"
                      [labTooltip]="beltId"
                      labTooltipType="pipe"
                    ></lab-icon>
                  }
                </div>
              }
            }
          </td>
        }
        <!-- Wagons (Value & Icon) -->
        @if (cols().wagons.show) {
          <td>
            @if (step.wagons) {
              <div class="flex justify-end font-mono whitespace-pre">
                {{ step.wagons | rate: cols().wagons.precision }}
              </div>
            }
          </td>
          <td>
            @if (
              step.itemId && itemsStore.settings()[step.itemId];
              as itemSettings
            ) {
              @if (itemSettings.wagonId; as wagonId) {
                <div class="flex">
                  @if (
                    data().cargoWagonIds.includes(wagonId)
                      ? 'cargo-wagon'
                      : data().fluidWagonIds.includes(wagonId)
                        ? 'fluid-wagon'
                        : null;
                    as type
                  ) {
                    <lab-select
                      [iconOnly]="true"
                      [border]="false"
                      [options]="
                        settingsStore.options()[
                          type === 'cargo-wagon' ? 'cargoWagons' : 'fluidWagons'
                        ]
                      "
                      [labTooltip]="wagonId"
                      [labTooltipType]="
                        type === 'cargo-wagon' ? 'cargo-wagon' : 'fluid-wagon'
                      "
                      labTooltipAction="steps.wagonTooltip"
                      labTooltipPosition="adjacent"
                      [ngModel]="wagonId"
                      (ngModelChange)="
                        itemsStore.updateRecordField(
                          step.itemId,
                          'wagonId',
                          $event,
                          itemSettings.defaultWagonId
                        )
                      "
                    ></lab-select>
                  }
                </div>
              }
            }
          </td>
        }
        <!-- Rockets (Value & Icon) -->
        @if (cols().rockets.show) {
          <td>
            @if (step.rockets) {
              <div class="flex justify-end font-mono whitespace-pre">
                {{ step.rockets | rate: cols().rockets.precision }}
              </div>
            }
          </td>
          <td>
            <div class="flex items-center">
              <lab-icon value="rocket-silo" type="item"></lab-icon>
            </div>
          </td>
        }
        <!-- Machines (Value & Icon) -->
        @if (step.recipeSettings?.machineId; as machineId) {
          <td class="pe-0">
            @if (
              step.machines &&
              step.machines.nonzero() &&
              !data().machineRecord[machineId].hideRate
            ) {
              <div class="flex justify-end font-mono whitespace-pre">
                {{ step.machines | rate: cols().machines.precision }}
              </div>
            }
          </td>
          <td class="ps-0">
            @if (step.recipeId && step.recipe && step.recipeSettings) {
              <div class="relative flex items-center gap-1">
                <span
                  class="absolute top-1 -z-1 text-transparent select-none"
                  aria-hidden="true"
                  >{{ data().recipeRecord[step.recipeId].name }}</span
                >
                <lab-recipes-select [step]="step"></lab-recipes-select>
                @if (!step.recipe.flags.has('hideProducer')) {
                  <lab-select
                    [border]="false"
                    [iconOnly]="true"
                    [options]="step.recipeSettings.machineOptions ?? []"
                    [labTooltip]="machineId"
                    labTooltipType="machine"
                    labTooltipPosition="adjacent"
                    labTooltipAction="steps.selectMachineTooltip"
                    [ngModel]="machineId"
                    (ngModelChange)="
                      objectivesStore.updateRecipeField(
                        step,
                        'machineId',
                        $event,
                        step.recipeSettings.defaultMachineId
                      )
                    "
                  ></lab-select>
                }

                @if (data().flags.has('overclock')) {
                  <lab-input-number
                    class="w-16"
                    [minimum]="rational.one"
                    [maximum]="rational(250)"
                    [step]="rational(10)"
                    [percent]="true"
                    [border]="false"
                    [ngModel]="step.recipeSettings.overclock"
                    (ngModelChange)="
                      objectivesStore.updateRecipeField(
                        step,
                        'overclock',
                        $event,
                        step.recipeSettings.defaultOverclock
                      )
                    "
                  ></lab-input-number>
                }

                @if (step.recipeSettings.fuelId; as fuelId) {
                  @if (step.recipe.flags.has('burn')) {
                    <lab-icon
                      [value]="fuelId"
                      type="item"
                      [labTooltip]="fuelId"
                      labTooltipType="fuel"
                    ></lab-icon>
                  } @else {
                    <lab-select
                      [border]="false"
                      [iconOnly]="true"
                      [options]="step.recipeSettings.fuelOptions ?? []"
                      [labTooltip]="fuelId"
                      labTooltipType="fuel"
                      labTooltipAction="steps.selectFuelTooltip"
                      [ngModel]="fuelId"
                      (ngModelChange)="
                        objectivesStore.updateRecipeField(
                          step,
                          'fuelId',
                          $event,
                          step.recipeSettings.defaultFuelId
                        )
                      "
                    ></lab-select>
                  }
                }

                @if (step.recipeSettings.modules; as modules) {
                  @if (data().machineRecord[machineId]; as machine) {
                    @if (machine.modules !== true && machine.modules?.isOne()) {
                      <lab-select
                        [iconOnly]="true"
                        [border]="false"
                        [options]="step.recipeSettings.moduleOptions ?? []"
                        [labTooltip]="modules[0].id || 'aside.modifierTooltip'"
                        [labTooltipType]="modules[0].id ? 'module' : undefined"
                        [labTooltipAction]="
                          modules[0].id ? 'aside.modifierTooltip' : undefined
                        "
                        [ngModel]="modules[0].id"
                        (ngModelChange)="
                          changeModulesBeacons(step, {
                            modules: [{ id: $event, count: rational.one }],
                          })
                        "
                      ></lab-select>
                    } @else if (machine.modules != null) {
                      <lab-modules-select
                        [machine]="machine"
                        [recipeId]="step.recipeId"
                        [border]="false"
                        [ngModel]="modules"
                        (ngModelChange)="
                          changeModulesBeacons(step, { modules: $event })
                        "
                      ></lab-modules-select>
                    }
                  }
                }
              </div>
            }
          </td>
        } @else {
          <td></td>
          <td class="ps-0">
            <lab-recipes-select [step]="step"></lab-recipes-select>
          </td>
        }
        <!-- Beacons -->
        @if (cols().beacons.show) {
          <td>
            @if (
              step.recipeId &&
              step.recipeSettings &&
              step.recipeSettings.beacons &&
              step.recipeSettings.beacons.length
            ) {
              <lab-beacons-select
                [border]="false"
                [ngModel]="step.recipeSettings.beacons"
                (ngModelChange)="
                  changeModulesBeacons(step, { beacons: $event })
                "
              ></lab-beacons-select>
            }
          </td>
        }
        <!-- Power -->
        @if (cols().power.show) {
          <td>
            @if (step.power) {
              <div class="flex justify-end font-mono whitespace-pre">
                {{
                  step.power
                    | power
                      : cols().power.precision
                      : objectivesStore.effectivePowerUnit()
                }}
              </div>
            }
          </td>
        }
        <!-- Pollution -->
        @if (cols().pollution.show) {
          <td>
            @if (step.pollution) {
              <span class="flex justify-end font-mono whitespace-pre">{{
                step.pollution | rate: cols().pollution.precision
              }}</span>
            }
          </td>
        }
        <!-- Link -->
        @if (cols().link.show) {
          <td>
            <div class="flex gap-1">
              <a
                target="_blank"
                routerLink="."
                [queryParams]="step | stepHref: routerSync.zipConfig() | async"
                labButton
                [faIcon]="faArrowUpRightFromSquare"
                [border]="false"
                labTooltip="steps.openNewTabTooltip"
                [attr.aria-label]="'steps.openNewTabTooltip' | translate"
              >
              </a>
              @let mod = objectivesStore.stepsModified();
              @if (
                (step.recipeId && mod.recipes[step.recipeId]) ||
                (step.itemId && mod.items[step.itemId]) ||
                (step.recipeObjectiveId &&
                  mod.objectives[step.recipeObjectiveId])
              ) {
                <button
                  type="button"
                  labButton
                  [faIcon]="faArrowRotateLeft"
                  [border]="false"
                  labTooltip="steps.stepUndoTooltip"
                  [attr.aria-label]="'steps.stepUndoTooltip' | translate"
                  (click)="resetStep(step)"
                ></button>
              }
            </div>
          </td>
        }
      </tr>
      @if (expanded) {
        <tr class="transition-all" animate.enter="animate-enter-translate-y">
          <td colspan="100">expansion row</td>
        </tr>
      }
    }
  </tbody>
</table>
