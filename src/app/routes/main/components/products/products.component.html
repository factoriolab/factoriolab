<p-card *ngIf="vm$ | async as vm" [header]="'products.title' | translate">
  <div
    *ngFor="
      let product of vm.products;
      last as last;
      trackBy: trackSvc.trackById
    "
    class="d-flex align-items-center"
    [class.mb-4]="!last"
  >
    <div class="p-inputgroup">
      <button
        pButton
        pRipple
        type="button"
        class="p-button-outlined"
        icon="fa-solid fa-minus"
        [pTooltip]="'products.removeProduct' | translate"
        (click)="removeProduct(product.id)"
      ></button>
      <button
        pButton
        pRipple
        type="button"
        class="d-inline-flex d-sm-none"
        [icon]="product.itemId | iconSmClass"
        [pTooltip]="'products.changeItem' | translate"
        (click)="editPicker.clickOpen(vm.data, product.itemId)"
      ></button>
      <button
        pButton
        pRipple
        type="button"
        class="d-none d-sm-inline-flex"
        [icon]="product.itemId | iconSmClass"
        [label]="vm.data.itemEntities[product.itemId].name"
        [pTooltip]="'products.changeItem' | translate"
        tooltipPosition="top"
        (click)="editPicker.clickOpen(vm.data, product.itemId)"
      ></button>
      <lab-picker
        #editPicker
        (selectId)="setItem(product.id, $event)"
      ></lab-picker>
      <span class="d-none d-md-block p-inputgroup-addon">{{
        'products.limitTo' | translate
      }}</span>
      <lab-input-number
        [pTooltip]="'products.changeRate' | translate"
        tooltipPosition="top"
        [value]="product.rate"
        (setValue)="setRate(product.id, $event)"
      ></lab-input-number>
      <p-dropdown
        [tooltip]="'products.changeRateType' | translate"
        tooltipPosition="top"
        [options]="vm.rateTypeOptions"
        [ngModel]="product.rateType"
        (onChange)="setRateType(product.id, $event.value)"
      ></p-dropdown>
      <ng-container
        *ngIf="vm.viaOptions[product.id].length > 0; else recipeNone"
      >
        <ng-container *ngIf="product.viaId as id">
          <p-dropdown
            class="d-inline-flex d-sm-none icon"
            [labDropdownIcon]="
              product.rateType === RateType.Factories ? 'recipe' : 'item'
            "
            [virtualScroll]="true"
            [virtualScrollItemSize]="48"
            [tooltip]="'products.changeVia' | translate"
            tooltipPosition="top"
            [options]="vm.viaOptions[product.id]"
            [ngModel]="product.viaId"
            (onChange)="setVia(product.id, $event.value)"
          >
          </p-dropdown>
          <p-dropdown
            class="d-none d-sm-inline-flex"
            [labDropdownIconText]="
              product.rateType === RateType.Factories ? 'recipe' : 'item'
            "
            [virtualScroll]="true"
            [virtualScrollItemSize]="48"
            [tooltip]="'products.changeVia' | translate"
            tooltipPosition="top"
            [options]="vm.viaOptions[product.id]"
            [ngModel]="product.viaId"
            (onChange)="setVia(product.id, $event.value)"
          >
            <ng-template pTemplate="selectedItem" let-item>
              <ng-container
                *ngIf="item.value === product.itemId; else showIcon"
              >
                {{ 'products.changeVia' | translate }}
              </ng-container>
              <ng-template #showIcon>
                <div class="d-flex align-items-center h-100">
                  <i [class]="item.value | iconSmClass"></i>
                  <div class="ms-3 text-truncate">
                    {{ item.label }}
                  </div>
                </div>
              </ng-template>
            </ng-template>
          </p-dropdown>
        </ng-container>
      </ng-container>
      <ng-template #recipeNone>
        <span class="p-inputgroup-addon p-error">{{
          'products.noEnabledRecipes' | translate
        }}</span>
      </ng-template>
    </div>
  </div>
  <div class="row mt-3">
    <div class="col-auto mt-2">
      <button
        pButton
        type="button"
        pRipple
        icon="fa-solid fa-plus"
        [label]="'products.addAProduct' | translate"
        (click)="addPicker.clickOpen(vm.data)"
      >
        <lab-picker #addPicker (selectId)="addProduct($event)"></lab-picker>
      </button>
    </div>
    <div class="col-auto mt-2">
      <p-dropdown
        labDropdownTranslate
        styleClass="h-100"
        [tooltip]="'products.selectDisplayRate' | translate"
        [ngModel]="vm.displayRate"
        [options]="displayRateOptions"
        (onChange)="setDisplayRate($event.value, vm.displayRate)"
      >
      </p-dropdown>
    </div>
  </div>
</p-card>
