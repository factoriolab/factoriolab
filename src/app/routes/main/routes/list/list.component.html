<ng-container *ngIf="vm$ | async as vm">
  <p-table
    #stepsTable
    dataKey="id"
    [rowTrackBy]="trackSvc.trackStep"
    styleClass="p-datatable-sm"
    [value]="vm.steps"
  >
    <ng-template pTemplate="header">
      <tr>
        <!-- Row actions -->
        <th class="w-0">
          <button
            pButton
            pRipple
            type="button"
            class="p-button-outlined p-button-rounded"
            icon="fa-solid fa-table-columns"
            [pTooltip]="'list.openColumnSettings' | translate"
            (click)="contentSvc.showColumns$.next()"
          ></button>
        </th>
        <!-- Checkbox -->
        <th *ngIf="vm.columns[Column.Checkbox].show">
          <div class="d-flex align-items-center justify-content-center">
            <i class="fa-solid fa-square-check"></i>
            <button
              *ngIf="vm.itemsModified.checked || vm.recipesModified.checked"
              pButton
              pRipple
              type="button"
              class="ms-2 p-button-text p-button-rounded"
              icon="fa-solid fa-rotate-left"
              [pTooltip]="'list.checkedUndoTooltip' | translate"
              (click)="resetChecked()"
            ></button>
          </div>
        </th>
        <!-- Tree -->
        <th *ngIf="vm.columns[Column.Tree].show">
          {{ 'list.tree' | translate }}
        </th>
        <!-- Items (Value / Icon)-->
        <th colspan="2">
          <div class="d-flex align-items-center">
            <span>{{ vm.dispRateInfo.itemsLabel | translate }}</span>
            <button
              *ngIf="vm.itemsModified.excluded"
              pButton
              pRipple
              type="button"
              class="ms-2 p-button-text p-button-rounded"
              icon="fa-solid fa-rotate-left"
              [pTooltip]="'list.itemsUndoTooltip' | translate"
              (click)="resetExcluded()"
            ></button>
          </div>
        </th>
        <!-- Belts -->
        <th *ngIf="vm.columns[Column.Belts].show" colspan="2">
          <div class="d-flex align-items-center">
            <span>{{ 'list.belts' | translate }}</span>
            <button
              *ngIf="vm.itemsModified.belts"
              pButton
              pRipple
              type="button"
              class="ms-2 p-button-text p-button-rounded"
              icon="fa-solid fa-rotate-left"
              [pTooltip]="'list.beltsUndoTooltip' | translate"
              (click)="resetBelts()"
            ></button>
          </div>
        </th>
        <!-- Wagons -->
        <th *ngIf="vm.columns[Column.Wagons].show" colspan="2">
          <div class="d-flex align-items-center">
            <span>{{ vm.dispRateInfo.wagonsLabel | translate }}</span>
            <button
              *ngIf="vm.itemsModified.wagons"
              pButton
              pRipple
              type="button"
              class="ms-2 p-button-text p-button-rounded"
              icon="fa-solid fa-rotate-left"
              [pTooltip]="'list.wagonsUndoTooltip' | translate"
              (click)="resetWagons()"
            ></button>
          </div>
        </th>
        <!-- Machines -->
        <th colspan="2">
          <div class="d-flex align-items-center">
            <span>{{ 'list.machines' | translate }}</span>
            <button
              *ngIf="vm.recipesModified.machines"
              pButton
              pRipple
              type="button"
              class="ms-2 p-button-text p-button-rounded"
              icon="fa-solid fa-rotate-left"
              [pTooltip]="'list.machinesUndoTooltip' | translate"
              (click)="resetMachines()"
            ></button>
          </div>
        </th>
        <!-- Beacons -->
        <th *ngIf="vm.columns[Column.Beacons].show" colspan="2">
          <div class="d-flex align-items-center">
            <span>{{ 'list.beacons' | translate }}</span>
            <button
              *ngIf="vm.recipesModified.beacons"
              pButton
              pRipple
              type="button"
              class="ms-2 p-button-text p-button-rounded"
              icon="fa-solid fa-rotate-left"
              [pTooltip]="'list.beaconsUndoTooltip' | translate"
              (click)="resetBeacons()"
            ></button>
          </div>
        </th>
        <!-- Power -->
        <th *ngIf="vm.columns[Column.Power].show">
          <span>{{ 'list.power' | translate }}</span>
        </th>
        <!-- Pollution -->
        <th *ngIf="vm.columns[Column.Pollution].show">
          <span>{{ vm.dispRateInfo.pollutionLabel | translate }}</span>
        </th>
        <!-- Link -->
        <th *ngIf="vm.columns[Column.Link].show" class="w-0">
          <button
            pButton
            pRipple
            type="button"
            class="p-button-outlined p-button-rounded"
            icon="fa-solid fa-file-arrow-down"
            data-test="lab-list-export"
            [pTooltip]="'list.downloadTooltip' | translate"
            tooltipPosition="left"
            (click)="
              export(
                vm.steps,
                vm.itemSettings,
                vm.recipeSettings,
                vm.columns,
                vm.data
              )
            "
          ></button>
        </th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-_step let-expanded="expanded">
      <tr *ngIf="_step | asStep as step">
        <!-- Expand row -->
        <td class="w-0 position-relative">
          <div [id]="'step_' + step.id" class="fragment"></div>
          <div
            *ngFor="let item of vm.stepDetails[step.id].tabs"
            [id]="'step_' + step.id + '_' + item.label"
            class="fragment"
          ></div>
          <div class="d-flex">
            <button
              pButton
              pRipple
              type="button"
              class="p-button-text p-button-rounded transition-ease"
              [class.fa-rotate-90]="expanded"
              icon="fa-solid fa-angle-right"
              [pTooltip]="
                (expanded ? 'list.hideDetails' : 'list.showDetails') | translate
              "
              [pRowToggler]="step"
            ></button>
          </div>
        </td>
        <!-- Checkbox -->
        <td *ngIf="vm.columns[Column.Checkbox].show">
          <div class="d-flex justify-content-center">
            <p-checkbox
              [binary]="true"
              [ngModel]="step.checked"
              (onChange)="changeStepChecked(step, $event.checked)"
            ></p-checkbox>
          </div>
        </td>
        <!-- Tree -->
        <td *ngIf="vm.columns[Column.Tree].show" class="overflow-hidden p-0">
          <div class="d-flex align-items-center links">
            <ng-container *ngIf="vm.stepTree[step.id]?.length">
              <div
                *ngFor="let i of vm.stepTree[step.id]; last as last"
                class="connect"
                [class.trail]="i"
                [class.last]="last"
              ></div>
              <div class="indent"></div>
            </ng-container>
            <div class="icon">
              <button
                *ngIf="
                  step.itemId && step.recipeObjectiveId == null;
                  else recipeIcon
                "
                pButton
                pRipple
                type="button"
                class="hover-action p-button-text"
                [class.hover-active]="vm.itemSettings[step.itemId].excluded"
                [icon]="step.itemId | iconSmClass"
                [pTooltip]="step.itemId | itemTooltip : vm.data"
                [escape]="false"
                (click)="
                  setItemExcluded(
                    step.itemId,
                    !vm.itemSettings[step.itemId].excluded
                  )
                "
              >
                <i class="hover-icon fa-solid fa-eye-slash"></i>
              </button>
              <ng-template #recipeIcon>
                <i
                  [class]="step.recipeId | iconSmClass : 'recipe'"
                  [pTooltip]="step.recipeId | recipeTooltip : vm.data"
                  [escape]="false"
                >
                  <span *ngIf="step.recipeObjectiveId != null"
                    >#{{ step.recipeObjectiveId }}</span
                  >
                </i>
              </ng-template>
            </div>
          </div>
        </td>
        <!-- Items (Value / Icon) -->
        <ng-container *ngIf="step.itemId && step.items; else emptyCol2">
          <td class="w-0 text-end">
            <span
              *ngIf="step.surplus && step.surplus.nonzero()"
              class="monospace"
              >(+{{ step.surplus | rate : vm.columns[Column.Items].precision }})
            </span>
            <span class="monospace">{{
              step.items.sub(step.surplus || Rational.zero)
                | rate : vm.columns[Column.Items].precision
            }}</span>
          </td>
          <td class="ps-0">
            <div class="d-flex align-items-center">
              <span class="find-text">{{
                vm.data.itemEntities[step.itemId].name
              }}</span>
              <button
                pButton
                pRipple
                type="button"
                class="hover-action p-button-text"
                [class.hover-active]="vm.itemSettings[step.itemId].excluded"
                [icon]="step.itemId | iconSmClass"
                [pTooltip]="step.itemId | itemTooltip : vm.data"
                [escape]="false"
                (click)="
                  setItemExcluded(
                    step.itemId,
                    !vm.itemSettings[step.itemId].excluded
                  )
                "
              >
                <i class="hover-icon fa-solid fa-eye-slash"></i>
              </button>
            </div>
          </td>
        </ng-container>
        <!-- Belts -->
        <ng-container *ngIf="vm.columns[Column.Belts].show">
          <ng-container *ngIf="step.itemId && step.belts; else emptyCol2">
            <ng-container *ngIf="vm.itemSettings[step.itemId].beltId as beltId">
              <td class="w-0 text-end">
                <span class="monospace">{{
                  step.belts | rate : vm.columns[Column.Belts].precision
                }}</span>
              </td>
              <td class="ps-0">
                <div class="d-flex align-items-center">
                  <!-- Belt dropdown -->
                  <p-dropdown
                    *ngIf="
                      vm.data.beltIds.indexOf(beltId) !== -1 &&
                        vm.settings.beltId;
                      else pipesDropdown
                    "
                    labDropdownBase="icon"
                    [pTooltip]="
                      'tooltip.belt'
                        | translate
                          : {
                              name: vm.data.itemEntities[beltId].name,
                              speed: vm.beltSpeedTxt[beltId],
                              suffix: vm.dispRateInfo.suffix | translate
                            }
                    "
                    [escape]="false"
                    [ngModel]="beltId"
                    [options]="vm.options.belts"
                    (onChange)="
                      setBelt(step.itemId, $event.value, vm.settings.beltId)
                    "
                  >
                    <ng-template pTemplate="selectedItem" let-item>
                      <div class="d-flex">
                        <i [class]="item.value | iconSmClass"></i>
                      </div>
                    </ng-template>
                    <ng-template pTemplate="item" let-item>
                      <div
                        class="d-flex align-items-center py-2 w-100 h-100"
                        [pTooltip]="
                          'tooltip.belt'
                            | translate
                              : {
                                  name: vm.data.itemEntities[item.value].name,
                                  speed: vm.beltSpeedTxt[item.value],
                                  suffix: vm.dispRateInfo.suffix | translate
                                }
                        "
                        [escape]="false"
                      >
                        <i [class]="item.value | iconSmClass"></i>
                        <div class="ms-3 text-truncate">
                          {{ item.label }}
                        </div>
                      </div>
                    </ng-template>
                  </p-dropdown>
                  <!-- Pipes dropdown -->
                  <ng-template #pipesDropdown>
                    <p-dropdown
                      *ngIf="
                        vm.data.pipeIds.indexOf(beltId) !== -1 &&
                          vm.settings.pipeId;
                        else pipeIcon
                      "
                      labDropdownBase="icon"
                      [pTooltip]="
                        'tooltip.pipe'
                          | translate
                            : {
                                name: vm.data.itemEntities[beltId].name,
                                speed: vm.beltSpeedTxt[beltId],
                                suffix: vm.dispRateInfo.suffix | translate
                              }
                      "
                      [escape]="false"
                      [ngModel]="beltId"
                      [options]="vm.options.pipes"
                      (onChange)="
                        setBelt(step.itemId, $event.value, vm.settings.pipeId)
                      "
                    >
                      <ng-template pTemplate="selectedItem" let-item>
                        <div class="d-flex">
                          <i [class]="item.value | iconSmClass"></i>
                        </div>
                      </ng-template>
                      <ng-template pTemplate="item" let-item>
                        <div
                          class="d-flex align-items-center py-2 w-100 h-100"
                          [pTooltip]="
                            'tooltip.pipe'
                              | translate
                                : {
                                    name: vm.data.itemEntities[item.value].name,
                                    speed: vm.beltSpeedTxt[item.value],
                                    suffix: vm.dispRateInfo.suffix | translate
                                  }
                          "
                          [escape]="false"
                        >
                          <i [class]="item.value | iconSmClass"></i>
                          <div class="ms-3 text-truncate">
                            {{ item.label }}
                          </div>
                        </div>
                      </ng-template>
                    </p-dropdown>
                  </ng-template>
                  <!-- Pipe icon only -->
                  <ng-template #pipeIcon>
                    <i
                      [class]="beltId | iconClass"
                      [pTooltip]="
                        'tooltip.pipe'
                          | translate
                            : {
                                name: vm.data.itemEntities[beltId].name,
                                speed: vm.beltSpeedTxt[beltId],
                                suffix: vm.dispRateInfo.suffix | translate
                              }
                      "
                      [escape]="false"
                    ></i>
                  </ng-template>
                </div>
              </td>
            </ng-container>
          </ng-container>
        </ng-container>
        <!-- Wagons -->
        <ng-container *ngIf="vm.columns[Column.Wagons].show">
          <ng-container
            *ngIf="
              step.itemId &&
                step.wagons &&
                vm.itemSettings[step.itemId].wagonId as wagonId;
              else emptyCol2
            "
          >
            <td class="w-0 text-end">
              <span class="monospace">{{
                step.wagons | rate : vm.columns[Column.Wagons].precision
              }}</span>
            </td>
            <td class="ps-0">
              <div class="d-flex align-items-center">
                <!-- Cargo wagon dropdown -->
                <p-dropdown
                  *ngIf="
                    vm.data.cargoWagonIds.indexOf(wagonId) !== -1 &&
                      vm.settings.cargoWagonId;
                    else fluidWagonsDropdown
                  "
                  labDropdownBase="icon"
                  [pTooltip]="
                    'tooltip.cargoWagon'
                      | translate
                        : {
                            name: vm.data.itemEntities[wagonId].name,
                            size: vm.data.cargoWagonEntities[wagonId].size
                          }
                  "
                  [escape]="false"
                  [ngModel]="wagonId"
                  [options]="vm.options.cargoWagons"
                  (onChange)="
                    setWagon(
                      step.itemId,
                      $event.value,
                      vm.settings.cargoWagonId
                    )
                  "
                >
                  <ng-template pTemplate="selectedItem" let-item>
                    <div class="d-flex">
                      <i [class]="item.value | iconSmClass"></i>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-item>
                    <div
                      class="d-flex align-items-center py-2 w-100 h-100"
                      [pTooltip]="
                        'tooltip.cargoWagon'
                          | translate
                            : {
                                name: vm.data.itemEntities[item.value].name,
                                size: vm.data.cargoWagonEntities[item.value]
                                  .size
                              }
                      "
                      [escape]="false"
                    >
                      <i [class]="item.value | iconSmClass"></i>
                      <div class="ms-3 text-truncate">
                        {{ item.label }}
                      </div>
                    </div>
                  </ng-template>
                </p-dropdown>
                <!-- Fluid wagon dropdown -->
                <ng-template #fluidWagonsDropdown>
                  <p-dropdown
                    *ngIf="
                      vm.data.fluidWagonIds.indexOf(wagonId) !== -1 &&
                      vm.settings.fluidWagonId
                    "
                    labDropdownBase="icon"
                    [pTooltip]="
                      'tooltip.fluidWagon'
                        | translate
                          : {
                              name: vm.data.itemEntities[wagonId].name,
                              size: vm.data.fluidWagonEntities[wagonId].capacity
                            }
                    "
                    [escape]="false"
                    [ngModel]="wagonId"
                    [options]="vm.options.fluidWagons"
                    (onChange)="
                      setWagon(
                        step.itemId,
                        $event.value,
                        vm.settings.fluidWagonId
                      )
                    "
                  >
                    <ng-template pTemplate="selectedItem" let-item>
                      <div class="d-flex">
                        <i [class]="item.value | iconSmClass"></i>
                      </div>
                    </ng-template>
                    <ng-template pTemplate="item" let-item>
                      <div
                        class="d-flex align-items-center py-2 w-100 h-100"
                        [pTooltip]="
                          'tooltip.fluidWagon'
                            | translate
                              : {
                                  name: vm.data.itemEntities[item.value].name,
                                  size: vm.data.fluidWagonEntities[item.value]
                                    .capacity
                                }
                        "
                        [escape]="false"
                      >
                        <i [class]="item.value | iconSmClass"></i>
                        <div class="ms-3 text-truncate">
                          {{ item.label }}
                        </div>
                      </div>
                    </ng-template>
                  </p-dropdown>
                </ng-template>
              </div>
            </td>
          </ng-container>
        </ng-container>
        <!-- Machines -->
        <ng-container
          *ngIf="step.recipeSettings?.machineId as machineId; else emptyCol2"
        >
          <td class="w-0 text-end">
            <span
              *ngIf="
                step.machines &&
                step.machines.nonzero() &&
                (machineId | machineShowRate : vm.data.game)
              "
              class="monospace"
              >{{
                step.machines
                  | machineRate
                    : vm.columns[Column.Machines].precision
                    : machineId
              }}</span
            >
          </td>
          <td class="ps-0">
            <ng-container *ngIf="machineId | machineShow : vm.data.game">
              <div
                *ngIf="step.recipeId && step.recipe && step.recipeSettings"
                class="d-flex align-items-center"
              >
                <span class="find-text">{{
                  vm.data.recipeEntities[step.recipeId].name
                }}</span>
                <i
                  class="padded"
                  [class]="step.recipeId | iconSmClass : 'recipe'"
                  [pTooltip]="step.recipeId | recipeTooltip : vm.data"
                  [escape]="false"
                  ><span *ngIf="step.recipeObjectiveId"
                    >#{{ step.recipeObjectiveId }}</span
                  ></i
                >
                <p-dropdown
                  *ngIf="vm.data.machineEntities[machineId] as machine"
                  labDropdownBase="icon"
                  [pTooltip]="machineId | machineTooltip : vm.data"
                  [escape]="false"
                  [options]="
                    step.recipe.producers | options : vm.data.itemEntities
                  "
                  [ngModel]="machineId"
                  (onChange)="
                    changeRecipeField(
                      step,
                      $event.value,
                      vm.machines,
                      vm.data,
                      RecipeField.Machine
                    )
                  "
                >
                  <ng-template pTemplate="selectedItem" let-item>
                    <div class="d-flex">
                      <i [class]="item.value | iconSmClass"></i>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-item>
                    <div
                      class="d-flex align-items-center py-2 w-100 h-100"
                      [pTooltip]="item.value | machineTooltip : vm.data"
                      [escape]="false"
                    >
                      <i [class]="item.value | iconSmClass"></i>
                      <div class="ms-3 text-truncate">
                        {{ item.label }}
                      </div>
                    </div>
                  </ng-template>
                </p-dropdown>
                <p-inputNumber
                  *ngIf="vm.data.game === Game.Satisfactory"
                  #overclockInput
                  suffix="%"
                  [min]="1"
                  [max]="250"
                  [step]="10"
                  [size]="2"
                  inputStyleClass="text-end"
                  [pTooltip]="'list.overclockTooltip' | translate"
                  [ngModel]="step.recipeSettings.overclock"
                  (onBlur)="
                    changeRecipeField(
                      step,
                      overclockInput.value,
                      vm.machines,
                      vm.data,
                      RecipeField.Overclock
                    )
                  "
                >
                </p-inputNumber>
                <ng-container
                  *ngIf="step.recipeSettings?.machineModuleIds as moduleIds"
                >
                  <p-dropdown
                    *ngFor="let moduleId of moduleIds; index as i; last as last"
                    labDropdownBase="icon"
                    class="module-dropdown"
                    [class.last]="last"
                    [pTooltip]="moduleId | moduleTooltip : vm.data"
                    tooltipPosition="top"
                    [escape]="false"
                    [options]="step.recipeSettings.machineModuleOptions ?? []"
                    [ngModel]="moduleId"
                    (onChange)="
                      changeRecipeField(
                        step,
                        $event.value,
                        vm.machines,
                        vm.data,
                        RecipeField.MachineModules,
                        i
                      )
                    "
                  >
                    <ng-template pTemplate="selectedItem" let-item>
                      <div class="d-flex">
                        <i [class]="item.value | iconSmClass"></i>
                      </div>
                    </ng-template>
                    <ng-template pTemplate="item" let-item>
                      <div
                        class="d-flex align-items-center py-2 w-100 h-100"
                        [pTooltip]="item.value | moduleTooltip : vm.data"
                        [escape]="false"
                      >
                        <i [class]="item.value | iconSmClass"></i>
                        <div class="ms-3 text-truncate">
                          {{ item.label }}
                        </div>
                      </div>
                    </ng-template>
                  </p-dropdown>
                </ng-container>
              </div>
            </ng-container>
          </td>
        </ng-container>
        <!-- Beacons -->
        <ng-container *ngIf="vm.columns[Column.Beacons].show">
          <ng-container
            *ngIf="step.recipeId && step.recipeSettings; else emptyCol2"
          >
            <td class="w-0 pe-0">
              <div
                class="d-flex"
                *ngFor="
                  let beacon of step.recipeSettings.beacons;
                  index as i;
                  trackBy: trackSvc.trackByIndex
                "
              >
                <button
                  *ngIf="i === 0; else deleteBeaconBtn"
                  pButton
                  pRipple
                  type="button"
                  class="p-button-text p-button-rounded"
                  icon="fa-solid fa-plus"
                  (click)="
                    addBeacon(
                      step.recipeObjectiveId ?? step.recipeId,
                      step.recipeObjectiveId != null
                    )
                  "
                ></button>
                <ng-template #deleteBeaconBtn>
                  <button
                    pButton
                    pRipple
                    type="button"
                    class="p-button-text p-button-rounded"
                    icon="fa-solid fa-minus"
                    (click)="
                      removeBeacon(
                        step.recipeObjectiveId ?? step.recipeId,
                        i,
                        step.recipeObjectiveId != null
                      )
                    "
                  ></button>
                </ng-template>
                <lab-input-number
                  *ngIf="beacon.count"
                  [pTooltip]="'list.beaconEachTooltip' | translate"
                  tooltipPosition="left"
                  class="text-end"
                  width="2.5rem"
                  [value]="beacon.count.toString()"
                  [textButtons]="true"
                  (setValue)="
                    changeRecipeField(
                      step,
                      $event,
                      vm.machines,
                      vm.data,
                      RecipeField.BeaconCount,
                      i
                    )
                  "
                ></lab-input-number>
              </div>
            </td>
            <td class="ps-0">
              <div
                *ngFor="let beacon of step.recipeSettings.beacons; index as i"
                class="d-flex"
              >
                <p-dropdown
                  *ngIf="beacon.id"
                  labDropdownBase="icon"
                  [pTooltip]="beacon.id | beaconTooltip : vm.data"
                  [escape]="false"
                  [options]="vm.options.beacons"
                  [ngModel]="beacon.id"
                  (onChange)="
                    changeRecipeField(
                      step,
                      $event.value,
                      vm.machines,
                      vm.data,
                      RecipeField.Beacon,
                      i
                    )
                  "
                >
                  <ng-template pTemplate="selectedItem" let-item>
                    <div class="d-flex">
                      <i [class]="item.value | iconSmClass"></i>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-item>
                    <div
                      class="d-flex align-items-center py-2 w-100 h-100"
                      [pTooltip]="item.value | beaconTooltip : vm.data"
                      [escape]="false"
                    >
                      <i [class]="item.value | iconSmClass"></i>
                      <div class="ms-3 text-truncate">
                        {{ item.label }}
                      </div>
                    </div>
                  </ng-template>
                </p-dropdown>
                <p-dropdown
                  *ngFor="
                    let moduleId of beacon.moduleIds;
                    index as j;
                    last as last
                  "
                  labDropdownBase="icon"
                  class="module-dropdown"
                  [class.last]="last"
                  [pTooltip]="moduleId | moduleTooltip : vm.data"
                  tooltipPosition="top"
                  [escape]="false"
                  [options]="beacon.moduleOptions ?? []"
                  [ngModel]="moduleId"
                  (onChange)="
                    changeRecipeField(
                      step,
                      $event.value,
                      vm.machines,
                      vm.data,
                      RecipeField.BeaconModules,
                      i,
                      j
                    )
                  "
                >
                  <ng-template pTemplate="selectedItem" let-item>
                    <div class="d-flex">
                      <i [class]="item.value | iconSmClass"></i>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-item>
                    <div
                      class="d-flex align-items-center py-2 w-100 h-100"
                      [pTooltip]="item.value | moduleTooltip : vm.data"
                      [escape]="false"
                    >
                      <i [class]="item.value | iconSmClass"></i>
                      <div class="ms-3 text-truncate">
                        {{ item.label }}
                      </div>
                    </div>
                  </ng-template>
                </p-dropdown>
                <lab-input-number
                  *ngIf="beacon.total"
                  [pTooltip]="'list.beaconTotalTooltip' | translate"
                  class="text-end"
                  width="3rem"
                  [value]="beacon.total.toString()"
                  [textButtons]="true"
                  (setValue)="
                    changeRecipeField(
                      step,
                      $event,
                      vm.machines,
                      vm.data,
                      RecipeField.BeaconTotal,
                      i
                    )
                  "
                ></lab-input-number>
              </div>
            </td>
          </ng-container>
        </ng-container>
        <!-- Power -->
        <td *ngIf="vm.columns[Column.Power].show" class="text-end">
          <span *ngIf="step.power && step.power.nonzero()" class="monospace">{{
            step.power
              | power
                : vm.columns[Column.Power].precision
                : vm.effectivePowerUnit
          }}</span>
        </td>
        <!-- Pollution -->
        <td *ngIf="vm.columns[Column.Pollution].show" class="text-end">
          <span
            *ngIf="step.pollution && step.pollution.nonzero()"
            class="monospace"
            >{{
              step.pollution | rate : vm.columns[Column.Pollution].precision
            }}</span
          >
        </td>
        <!-- Link -->
        <td *ngIf="vm.columns[Column.Link].show">
          <div class="d-flex">
            <a
              class="text-decoration-none"
              target="_blank"
              [href]="step | stepHref : vm.zipPartial : vm.data"
            >
              <button
                pButton
                pRipple
                type="button"
                class="p-button-text p-button-rounded"
                icon="fa-solid fa-arrow-up-right-from-square"
                [pTooltip]="'list.openNewTabTooltip' | translate"
                tooltipPosition="left"
              ></button>
            </a>
            <button
              *ngIf="
                (step.recipeId && vm.stepsModified.recipes[step.recipeId]) ||
                (step.itemId && vm.stepsModified.items[step.itemId]) ||
                (step.recipeObjectiveId &&
                  vm.stepsModified.recipeObjectives[step.recipeObjectiveId])
              "
              pButton
              pRipple
              type="button"
              class="p-button-text p-button-rounded"
              icon="fa-solid fa-rotate-left"
              [pTooltip]="'list.stepUndoTooltip' | translate"
              tooltipPosition="left"
              (click)="resetStep(step)"
            ></button>
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="rowexpansion" let-_step>
      <!-- Details row tab menu -->
      <ng-container *ngIf="_step | asStep as step">
        <tr>
          <td>
            <a class="text-decoration-none" [href]="'#step_' + step.id">
              <button
                pButton
                pRipple
                type="button"
                class="p-button-text p-button-rounded"
                icon="fa-solid fa-link"
              ></button>
            </a>
          </td>
          <td colspan="100">
            <p-tabMenu
              #expandTabMenu
              [model]="vm.stepDetails[step.id].tabs"
              [activeItem]="vm.stepDetails[step.id].tabs[0]"
            >
              <ng-template pTemplate="item" let-item>
                {{ 'options.stepDetailTab.' + item.label | translate }}
              </ng-template>
            </p-tabMenu>
          </td>
        </tr>
        <ng-container [ngSwitch]="expandTabMenu.activeItem.label">
          <!-- Item row details -->
          <ng-container *ngSwitchCase="StepDetailTab.Item">
            <tr *ngIf="vm.stepDetails[step.id].outputs.length" class="detail">
              <ng-template *ngTemplateOutlet="leftPad"></ng-template>
              <td colspan="100" class="fw-bold">
                {{ 'list.sources' | translate }}
              </td>
            </tr>
            <ng-container
              *ngFor="let output of vm.stepDetails[step.id].outputs"
            >
              <ng-container *ngIf="step.itemId">
                <ng-container
                  *ngTemplateOutlet="
                    detailRow;
                    context: {
                      items: step.items?.mul(output.value),
                      itemId: step.itemId,
                      belts: step.belts?.mul(output.value),
                      beltId: vm.itemSettings[step.itemId].beltId,
                      wagons: step.wagons?.mul(output.value),
                      wagonId: vm.itemSettings[step.itemId].wagonId,
                      machines: output.machines,
                      machineId:
                        output.recipeId &&
                        vm.recipeSettings[output.recipeId].machineId,
                      recipeId: output.recipeId,
                      recipeObjectiveId: output.recipeObjectiveId,
                      percent: output.value,
                      percentOnDest: true,
                      destId: step.itemId,
                      inputs: output.inputs
                    }
                  "
                >
                </ng-container>
              </ng-container>
            </ng-container>
            <tr *ngIf="step.parents" class="detail">
              <ng-template *ngTemplateOutlet="leftPad"></ng-template>
              <td colspan="100" class="fw-bold">
                {{ 'list.destinations' | translate }}
              </td>
            </tr>
            <ng-container
              *ngFor="
                let parent of step.parents | keyvalue : trackSvc.sortByValue
              "
            >
              <ng-container *ngIf="step.itemId">
                <ng-container
                  *ngTemplateOutlet="
                    detailRow;
                    context: {
                      items: step.items?.mul(parent.value),
                      itemId: step.itemId,
                      belts: step.belts?.mul(parent.value),
                      beltId: vm.itemSettings[step.itemId].beltId,
                      wagons: step.wagons?.mul(parent.value),
                      wagonId: vm.itemSettings[step.itemId].wagonId,
                      machines:
                        vm.stepDetails[step.id].outputs.length === 1
                          ? step.machines?.mul(parent.value)
                          : null,
                      machineId:
                        vm.stepDetails[step.id].outputs.length === 1
                          ? step.recipeSettings?.machineId
                          : null,
                      recipeId: step.recipeId,
                      recipeObjectiveId: step.recipeObjectiveId,
                      percent: parent.value,
                      destId: vm.stepById[parent.key]?.recipeId,
                      destRecipeObjectiveId:
                        vm.stepById[parent.key]?.recipeObjectiveId,
                      destIsRecipe: true,
                      outputs: parent.key === ''
                    }
                  "
                >
                </ng-container>
              </ng-container>
            </ng-container>
          </ng-container>
          <!-- Recipe row details -->
          <ng-container *ngSwitchCase="StepDetailTab.Recipe">
            <ng-container *ngIf="step.recipeId && step.recipeSettings">
              <ng-container
                *ngIf="
                  vm.data.game === Game.Factorio &&
                  step.recipeSettings.machineId &&
                  vm.data.itemEntities[step.recipeSettings.machineId].machine
                    ?.mining
                "
              >
                <tr class="detail">
                  <ng-template *ngTemplateOutlet="leftPad"></ng-template>
                  <td colspan="100" class="fw-bold">
                    {{ 'list.depletion' | translate }}
                  </td>
                </tr>
                <ng-container
                  *ngFor="
                    let output of step.outputs | keyvalue : trackSvc.sortByValue
                  "
                >
                  <ng-container
                    *ngIf="{
                      step: vm.stepByItemEntities[output.key],
                      percent: step.outputs?.[output.key]
                    } as row"
                  >
                    <ng-container
                      *ngIf="row.step && row.percent && row.step.items"
                    >
                      <ng-container
                        *ngTemplateOutlet="
                          detailRow;
                          context: {
                            items: row.step.items
                              .mul(row.percent)
                              .div(vm.data.recipeR[step.recipeId].productivity),
                            itemId: output.key
                          }
                        "
                      >
                      </ng-container>
                    </ng-container>
                  </ng-container>
                </ng-container>
              </ng-container>
              <ng-container
                *ngIf="step.recipe && (step.recipe.in | keyvalue).length"
              >
                <tr class="detail">
                  <ng-template *ngTemplateOutlet="leftPad"></ng-template>
                  <td colspan="100" class="fw-bold">
                    {{ 'list.inputs' | translate }}
                  </td>
                </tr>
                <ng-container
                  *ngFor="
                    let input of step.recipe.in
                      | keyvalue : trackSvc.sortByValue
                  "
                >
                  <ng-container
                    *ngIf="{
                      step: vm.stepByItemEntities[input.key], 
                      percent: vm.stepByItemEntities[input.key].parents?.[step.id]
                    } as row"
                  >
                    <ng-container *ngIf="row.step.itemId && row.percent">
                      <ng-container
                        *ngTemplateOutlet="
                          detailRow;
                          context: {
                            items: row.step.items?.mul(row.percent),
                            itemId: input.key,
                            belts: row.step.belts?.mul(row.percent),
                            beltId: vm.itemSettings[row.step.itemId].beltId,
                            wagons: row.step.wagons?.mul(row.percent),
                            wagonId: vm.itemSettings[row.step.itemId].wagonId,
                            machines: row.step.machines?.mul(row.percent),
                            machineId: row.step.recipeSettings?.machineId,
                            recipeId: row.step.recipeId,
                            recipeObjectiveId: row.step.recipeObjectiveId,
                            percent: row.percent,
                            destId: step.recipeId,
                            destRecipeObjectiveId: step.recipeObjectiveId,
                            destIsRecipe: true
                          }
                        "
                      >
                      </ng-container>
                    </ng-container>
                  </ng-container>
                </ng-container>
              </ng-container>
              <tr class="detail">
                <ng-template *ngTemplateOutlet="leftPad"></ng-template>
                <td colspan="100" class="fw-bold">
                  {{ 'list.outputs' | translate }}
                </td>
              </tr>
              <ng-container
                *ngFor="
                  let output of vm.data.recipeR[step.recipeId].out
                    | keyvalue : trackSvc.sortByValue
                "
              >
                <ng-container
                  *ngIf="{
                    step: vm.stepByItemEntities[output.key], 
                    percent: step.outputs?.[output.key]
                  } as row"
                >
                  <ng-container *ngIf="row.step.itemId && row.percent">
                    <ng-container
                      *ngTemplateOutlet="
                        detailRow;
                        context: {
                          items: row.step.items?.mul(row.percent),
                          itemId: output.key,
                          belts: row.step.belts?.mul(row.percent),
                          beltId: vm.itemSettings[row.step.itemId].beltId,
                          wagons: row.step.wagons?.mul(row.percent),
                          wagonId: vm.itemSettings[row.step.itemId].wagonId,
                          machines: row.step.machines?.mul(row.percent),
                          machineId: row.step.recipeSettings?.machineId,
                          recipeId: row.step.recipeId,
                          recipeObjectiveId: row.step.recipeObjectiveId,
                          percent: row.percent,
                          percentOnDest: true,
                          destId: step.recipeId,
                          destRecipeObjectiveId: step.recipeObjectiveId,
                          destIsRecipe: true
                        }
                      "
                    >
                    </ng-container>
                  </ng-container>
                </ng-container>
              </ng-container>
            </ng-container>
          </ng-container>
          <!-- Machine row details -->
          <tr *ngSwitchCase="StepDetailTab.Machine" class="detail">
            <td></td>
            <td colspan="100">
              <div
                *ngIf="step.recipeId && step.machines"
                class="d-flex align-items-center"
              >
                <table class="mw-0">
                  <ng-container
                    *ngFor="
                      let input of vm.data.recipeR[step.recipeId].in
                        | keyvalue : trackSvc.sortByValue
                    "
                  >
                    <ng-container
                      *ngIf="{
                        step: vm.stepByItemEntities[input.key],
                        percent: vm.stepByItemEntities[input.key].parents?.[step.id]
                      } as row"
                    >
                      <tr *ngIf="row.percent">
                        <td>
                          <ng-container *ngIf="row.step.items">
                            <ng-container
                              *ngTemplateOutlet="
                                machineValueCell;
                                context: {
                                  value:
                                    row.step.items
                                      .mul(row.percent)
                                      .div(step.machines)
                                    | rate : vm.columns[Column.Items].precision,
                                  itemId: input.key
                                }
                              "
                            >
                            </ng-container>
                          </ng-container>
                        </td>
                        <td *ngIf="vm.columns[Column.Belts].show">
                          <ng-container *ngIf="row.step.belts">
                            <ng-container
                              *ngIf="
                                vm.itemSettings[input.key].beltId as beltId
                              "
                            >
                              <ng-container
                                *ngTemplateOutlet="
                                  machineValueCell;
                                  context: {
                                    value:
                                      row.step.belts
                                        .mul(row.percent)
                                        .div(step.machines)
                                      | rate
                                        : vm.columns[Column.Belts].precision,
                                    itemId: beltId
                                  }
                                "
                              >
                              </ng-container>
                            </ng-container>
                          </ng-container>
                        </td>
                        <ng-container *ngIf="vm.data.game === Game.Factorio">
                          <td>
                            <ng-container
                              *ngIf="
                                vm.itemSettings[input.key].beltId !==
                                  ItemId.Pipe && row.step.items
                              "
                            >
                              <ng-container
                                *ngIf="
                                  row.step.items
                                    .mul(row.percent)
                                    .div(step.machines)
                                    .div(vm.dispRateInfo.value)
                                    | inserterSpeed : vm.settings as ins
                                "
                              >
                                <ng-container
                                  *ngTemplateOutlet="
                                    machineValueCell;
                                    context: {
                                      value: ins.value | rate : 1,
                                      itemId: ins.id
                                    }
                                  "
                                >
                                </ng-container>
                              </ng-container>
                            </ng-container>
                          </td>
                        </ng-container>
                      </tr>
                    </ng-container>
                  </ng-container>
                </table>
                <i class="fa-solid fa-arrow-right mx-3"></i>
                <table class="mw-0">
                  <tr>
                    <td class="monospace">1</td>
                    <td>
                      <div
                        *ngIf="step.recipeSettings?.machineId as machineId"
                        class="d-flex align-items-center"
                      >
                        <i
                          [class]="step.recipeId | iconClass : 'recipe'"
                          [pTooltip]="step.recipeId | recipeTooltip : vm.data"
                          [escape]="false"
                        ></i>
                        <i
                          [class]="machineId | iconClass"
                          [pTooltip]="machineId | machineTooltip : vm.data"
                          [escape]="false"
                        ></i>
                      </div>
                    </td>
                  </tr>
                </table>
                <i class="fa-solid fa-arrow-right mx-3"></i>
                <table class="mw-0">
                  <ng-container
                    *ngFor="
                      let output of vm.data.recipeR[step.recipeId].out
                        | keyvalue : trackSvc.sortByValue
                    "
                  >
                    <tr
                      *ngIf="
                        output.value.div(
                          vm.data.recipeR[step.recipeId].time
                        ) as items
                      "
                    >
                      <ng-container *ngIf="vm.data.game === Game.Factorio">
                        <td>
                          <ng-container
                            *ngIf="
                              vm.itemSettings[output.key].beltId !== ItemId.Pipe
                            "
                          >
                            <ng-container
                              *ngIf="items | inserterSpeed : vm.settings as ins"
                            >
                              <ng-container
                                *ngTemplateOutlet="
                                  machineValueCell;
                                  context: {
                                    value: ins.value | rate : 1,
                                    itemId: ins.id
                                  }
                                "
                              >
                              </ng-container>
                            </ng-container>
                          </ng-container>
                        </td>
                      </ng-container>
                      <td *ngIf="vm.columns[Column.Belts].show">
                        <ng-container
                          *ngIf="vm.itemSettings[output.key].beltId as beltId"
                        >
                          <ng-container
                            *ngTemplateOutlet="
                              machineValueCell;
                              context: {
                                value:
                                  items.div(vm.beltSpeed[beltId])
                                  | rate : vm.columns[Column.Belts].precision,
                                itemId: beltId
                              }
                            "
                          >
                          </ng-container>
                        </ng-container>
                      </td>
                      <td>
                        <ng-container
                          *ngTemplateOutlet="
                            machineValueCell;
                            context: {
                              value:
                                items.mul(vm.dispRateInfo.value)
                                | rate : vm.columns[Column.Items].precision,
                              itemId: output.key
                            }
                          "
                        >
                        </ng-container>
                      </td>
                    </tr>
                  </ng-container>
                </table>
                <ng-template
                  #machineValueCell
                  let-value="value"
                  let-itemId="itemId"
                >
                  <div class="d-flex align-items-center justify-content-end">
                    <span class="monospace">{{ value }}</span>
                    <i
                      [class]="itemId | iconClass"
                      [pTooltip]="itemId | itemTooltip : vm.data"
                      [escape]="false"
                    ></i>
                  </div>
                </ng-template>
              </div>
              <div *ngIf="vm.data.game === Game.Factorio">
                <small
                  [innerHTML]="'list.inserterCountInfo' | translate"
                ></small>
              </div>
            </td>
          </tr>
          <!-- Recipes row details -->
          <ng-container *ngSwitchCase="StepDetailTab.Recipes">
            <ng-container *ngIf="step.itemId">
              <tr class="detail">
                <td></td>
                <td colspan="100">
                  <div>
                    <div class="fw-bold">
                      {{ 'list.includedRecipes' | translate }}
                    </div>
                    <div>
                      <small>{{
                        'list.includedRecipesInfo' | translate
                      }}</small>
                    </div>
                  </div>
                </td>
              </tr>
              <tr class="detail">
                <td></td>
                <td colspan="100">
                  <div class="d-flex flex-wrap">
                    <button
                      *ngFor="let recipeId of vm.stepDetails[step.id].recipeIds"
                      pButton
                      pRipple
                      type="button"
                      class="hover-action p-button-text me-2"
                      [class.hover-active]="
                        vm.recipeSettings[recipeId].excluded
                      "
                      [icon]="recipeId | iconSmClass : 'recipe'"
                      [pTooltip]="recipeId | recipeTooltip : vm.data"
                      [escape]="false"
                      (click)="
                        toggleRecipe(recipeId, vm.recipeSettings, vm.data)
                      "
                    >
                      <i class="hover-icon fa-solid fa-eye-slash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </ng-container>
          </ng-container>
        </ng-container>
      </ng-container>
    </ng-template>
    <ng-template #emptyCol2>
      <td colspan="2"></td>
    </ng-template>
    <ng-template #leftPad>
      <td></td>
      <td *ngIf="vm.columns[Column.Tree].show"></td>
    </ng-template>
    <ng-template
      #detailRow
      let-items="items"
      let-itemId="itemId"
      let-belts="belts"
      let-beltId="beltId"
      let-wagons="wagons"
      let-wagonId="wagonId"
      let-machines="machines"
      let-machineId="machineId"
      let-recipeId="recipeId"
      let-recipeObjectiveId="recipeObjectiveId"
      let-percent="percent"
      let-percentOnDest="percentOnDest"
      let-destId="destId"
      let-destRecipeObjectiveId="destRecipeObjectiveId"
      let-destIsRecipe="destIsRecipe"
      let-inputs="inputs"
      let-outputs="outputs"
    >
      <tr class="detail">
        <ng-container *ngIf="itemId">
          <ng-template *ngTemplateOutlet="leftPad"></ng-template>
          <td class="w-0 text-end">
            <span class="monospace">{{
              items | rate : vm.columns[Column.Items].precision
            }}</span>
          </td>
          <td class="ps-0">
            <div class="d-flex">
              <i
                [class]="itemId | iconClass"
                [pTooltip]="itemId | itemTooltip : vm.data"
                [escape]="false"
              ></i>
            </div>
          </td>
          <ng-container *ngIf="vm.columns[Column.Belts].show">
            <ng-container *ngIf="belts && beltId">
              <td class="w-0 text-end">
                <span class="monospace">{{
                  belts | rate : vm.columns[Column.Belts].precision
                }}</span>
              </td>
              <td class="ps-0">
                <div class="d-flex">
                  <i
                    [class]="beltId | iconClass"
                    [pTooltip]="
                      'tooltip.belt'
                        | translate
                          : {
                              name: vm.data.itemEntities[beltId].name,
                              speed: vm.beltSpeedTxt[beltId],
                              suffix: vm.dispRateInfo.suffix | translate
                            }
                    "
                    [escape]="false"
                  ></i>
                </div>
              </td>
            </ng-container>
          </ng-container>
          <ng-container *ngIf="vm.columns[Column.Wagons].show">
            <ng-container *ngIf="wagons && wagonId">
              <td class="w-0 text-end">
                <span class="monospace">{{
                  wagons | rate : vm.columns[Column.Wagons].precision
                }}</span>
              </td>
              <td class="ps-0">
                <div class="d-flex">
                  <i
                    *ngIf="
                      vm.data.cargoWagonIds.indexOf(wagonId) !== -1;
                      else fluidWagonIcon
                    "
                    [class]="wagonId | iconClass"
                    [pTooltip]="
                      'tooltip.cargoWagon'
                        | translate
                          : {
                              name: vm.data.itemEntities[wagonId].name,
                              size: vm.data.cargoWagonEntities[wagonId].size
                            }
                    "
                    [escape]="false"
                  ></i>
                  <ng-template #fluidWagonIcon>
                    <i
                      [class]="wagonId | iconClass"
                      [pTooltip]="
                        'tooltip.fluidWagon'
                          | translate
                            : {
                                name: vm.data.itemEntities[wagonId].name,
                                size: vm.data.fluidWagonEntities[wagonId]
                                  .capacity
                              }
                      "
                      [escape]="false"
                    ></i>
                  </ng-template>
                </div>
              </td>
            </ng-container>
          </ng-container>
          <td class="w-0 text-end">
            <span
              *ngIf="
                machines &&
                machines.nonzero() &&
                (machineId | machineShowRate : vm.data.game)
              "
              class="monospace"
              >{{
                machines
                  | machineRate
                    : vm.columns[Column.Machines].precision
                    : machineId
              }}</span
            >
          </td>
          <td class="p-0" colspan="100">
            <div class="d-flex align-items-center">
              <div *ngIf="inputs" class="position-absolute">
                {{ 'list.inputs' | translate }}
              </div>
              <ng-container
                *ngIf="machineId | machineShow : vm.data.game; else machineFill"
              >
                <i
                  [class]="recipeId | iconClass : 'recipe'"
                  [pTooltip]="recipeId | recipeTooltip : vm.data"
                  [escape]="false"
                  ><span *ngIf="recipeObjectiveId"
                    >#{{ recipeObjectiveId }}</span
                  ></i
                >
                <i
                  [class]="machineId | iconClass"
                  [pTooltip]="machineId | machineTooltip : vm.data"
                  [escape]="false"
                ></i>
              </ng-container>
              <ng-template #machineFill>
                <div class="d-flex invisible">
                  <i class="lab-icon"></i>
                </div>
                <div class="d-flex invisible">
                  <i class="lab-icon"></i>
                </div>
              </ng-template>
              <ng-container *ngIf="percent">
                <i
                  class="m-1 p-2 fa-solid fa-arrow-right"
                  *ngIf="percentOnDest"
                ></i>
                <span class="monospace"
                  >{{ percent | rate : -2 | leftPad }}%</span
                >
                <i
                  class="m-1 p-2 fa-solid fa-arrow-right"
                  *ngIf="!percentOnDest"
                ></i>
                <i
                  *ngIf="destId"
                  [class]="
                    destId | iconClass : (destIsRecipe ? 'recipe' : 'item')
                  "
                  [pTooltip]="
                    destIsRecipe
                      ? (destId | recipeTooltip : vm.data)
                      : (destId | itemTooltip : vm.data)
                  "
                  [escape]="false"
                  ><span *ngIf="destRecipeObjectiveId"
                    >#{{ destRecipeObjectiveId }}</span
                  ></i
                >
                <span *ngIf="outputs">
                  {{ 'list.outputs' | translate }}
                </span>
              </ng-container>
            </div>
          </td>
        </ng-container>
      </tr>
    </ng-template>
    <ng-template pTemplate="footer">
      <tr>
        <td></td>
        <td *ngIf="vm.columns[Column.Tree].show"></td>
        <td colspan="2">
          {{ 'list.total' | translate }}
        </td>
        <ng-container
          *ngTemplateOutlet="
            totalCell;
            context: { column: Column.Belts, totals: vm.totals.belts }
          "
        >
        </ng-container>
        <ng-container
          *ngTemplateOutlet="
            totalCell;
            context: { column: Column.Wagons, totals: vm.totals.wagons }
          "
        >
        </ng-container>
        <ng-container
          *ngTemplateOutlet="
            totalCell;
            context: {
              column: Column.Machines,
              totals: vm.totals.machines,
              modulesTotals: vm.totals.machineModules
            }
          "
        >
        </ng-container>
        <ng-container
          *ngTemplateOutlet="
            totalCell;
            context: {
              column: Column.Beacons,
              totals: vm.totals.beacons,
              modulesTotals: vm.totals.beaconModules
            }
          "
        >
        </ng-container>
        <td *ngIf="vm.columns[Column.Power].show" class="text-end inherit">
          <span class="monospace">{{
            vm.totals.power
              | power
                : vm.columns[Column.Power].precision
                : vm.effectivePowerUnit
          }}</span>
        </td>
        <td *ngIf="vm.columns[Column.Pollution].show" class="text-end inherit">
          <span class="monospace">{{
            vm.totals.pollution | rate : vm.columns[Column.Pollution].precision
          }}</span>
        </td>
        <td *ngIf="vm.columns[Column.Link].show"></td>
      </tr>
      <ng-template
        #totalCell
        let-column="column"
        let-totals="totals"
        let-modulesTotals="modulesTotals"
      >
        <ng-container *ngIf="vm.columns[column].show">
          <td class="w-0 text-end inherit">
            <div
              *ngFor="let tot of totals | keyvalue : trackSvc.sortByValue"
              class="py-2 icon-height"
            >
              <span class="monospace">{{
                tot.value | rate : vm.columns[column].precision
              }}</span>
            </div>
          </td>
          <td class="ps-0 inherit">
            <div class="d-flex">
              <div class="d-flex flex-column justify-content-center">
                <i
                  *ngFor="let tot of totals | keyvalue : trackSvc.sortByValue"
                  class="d-block"
                  [class]="tot.key | iconClass : 'item'"
                  [pTooltip]="
                    vm.data.itemEntities[tot.key]?.name ||
                    vm.data.recipeEntities[tot.key].name
                  "
                ></i>
              </div>
              <div class="modules-column">
                <ng-container
                  *ngFor="
                    let tot of modulesTotals | keyvalue : trackSvc.sortByValue
                  "
                >
                  <div class="py-2 icon-height">
                    <span class="monospace">{{ tot.value }}</span>
                  </div>
                  <i
                    class="d-block"
                    [class]="tot.key | iconClass : 'item'"
                    [escape]="false"
                    [pTooltip]="tot.key | moduleTooltip : vm.data"
                  ></i>
                </ng-container>
              </div>
            </div>
          </td>
        </ng-container>
      </ng-template>
    </ng-template>
  </p-table>
</ng-container>
