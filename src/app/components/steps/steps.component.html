<p-table
  #stepsTable
  dataKey="id"
  [rowTrackBy]="trackSvc.trackStep"
  styleClass="p-datatable-sm"
  [value]="steps()"
  [customSort]="true"
  [rowExpandMode]="focus() ? 'single' : 'multiple'"
  [defaultSortOrder]="-1"
  [paginator]="!focus() && !preferences().disablePaginator"
  [rows]="preferences().rows"
  [rowsPerPageOptions]="[25, 50, 100, 1000]"
  (rowsChange)="preferencesSvc.apply({ rows: $event })"
  [showCurrentPageReport]="true"
  (sortFunction)="sortSteps$.next($event)"
>
  <ng-template pTemplate="header">
    <tr>
      <!-- Table actions row -->
      <td colspan="100">
        <div class="d-flex gap-2 py-2">
          <button
            pButton
            pRipple
            type="button"
            class="p-button-outlined"
            icon="fa-solid fa-table-columns"
            [label]="'steps.columnSettings' | translate"
            (click)="columnsDlg.open(columnsState())"
          ></button>
          @if (steps().length) {
            <button
              pButton
              pRipple
              type="button"
              class="p-button-outlined"
              icon="fa-solid fa-file-arrow-down"
              [label]="'steps.downloadAsCsv' | translate"
              (click)="exportSvc.stepsToCsv(steps())"
            ></button>
          }
        </div>
      </td>
    </tr>
    <tr class="column-header-row">
      <!-- Row actions -->
      <th></th>
      <!-- Checkbox -->
      @if (!focus() && columnsState().checkbox.show) {
        <th>
          <div class="d-flex align-items-center justify-content-center">
            <i class="fa-solid fa-square-check"></i>
            @if (
              settings().checkedItemIds.size ||
              settings().checkedRecipeIds.size ||
              settings().checkedObjectiveIds.size
            ) {
              <button
                pButton
                pRipple
                type="button"
                class="ms-2 p-button-text p-button-rounded"
                icon="fa-solid fa-rotate-left"
                [pTooltip]="'steps.checkedUndoTooltip' | translate"
                (click)="resetChecked()"
              ></button>
            }
          </div>
        </th>
      }
      <!-- Tree -->
      @if (!focus() && columnsState().tree.show) {
        <th>{{ 'options.column.tree' | translate }}</th>
      }
      <!-- Items (Value / Icon)-->
      <th colspan="2" pSortableColumn="items">
        <div class="d-flex align-items-center">
          <span>{{ dispRateInfo().itemsLabel | translate }}</span>
          @if (!focus()) {
            <p-sortIcon field="items"></p-sortIcon>
          }
          @if (settings().excludedItemIds.size) {
            <button
              pButton
              pRipple
              type="button"
              class="ms-2 p-button-text p-button-rounded"
              icon="fa-solid fa-rotate-left"
              [pTooltip]="'steps.itemsUndoTooltip' | translate"
              (click)="resetExcludedItems($event)"
            ></button>
          }
        </div>
      </th>
      <!-- Belts -->
      @if (columnsState().belts.show) {
        <th colspan="2" pSortableColumn="belts">
          <div class="d-flex align-items-center">
            <span>{{ 'options.column.belts' | translate }}</span>
            @if (!focus()) {
              <p-sortIcon field="belts"></p-sortIcon>
            }
            @if (itemsModified().belts) {
              <button
                pButton
                pRipple
                type="button"
                class="ms-2 p-button-text p-button-rounded"
                icon="fa-solid fa-rotate-left"
                [pTooltip]="'steps.beltsUndoTooltip' | translate"
                (click)="resetBelts($event)"
              ></button>
            }
          </div>
        </th>
      }
      <!-- Wagons -->
      @if (columnsState().wagons.show) {
        <th colspan="2" pSortableColumn="wagons">
          <div class="d-flex align-items-center">
            <span>{{ dispRateInfo().wagonsLabel | translate }}</span>
            @if (!focus()) {
              <p-sortIcon field="wagons"></p-sortIcon>
            }
            @if (itemsModified().wagons) {
              <button
                pButton
                pRipple
                type="button"
                class="ms-2 p-button-text p-button-rounded"
                icon="fa-solid fa-rotate-left"
                [pTooltip]="'steps.wagonsUndoTooltip' | translate"
                (click)="resetWagons($event)"
              ></button>
            }
          </div>
        </th>
      }
      <!-- Machines -->
      <th colspan="2" pSortableColumn="machines">
        <div class="d-flex align-items-center">
          <span>{{ 'options.column.machines' | translate }}</span>
          @if (!focus()) {
            <p-sortIcon field="machines"></p-sortIcon>
          }
          @if (recipesModified().machines) {
            <button
              pButton
              pRipple
              type="button"
              class="ms-2 p-button-text p-button-rounded"
              icon="fa-solid fa-rotate-left"
              [pTooltip]="'steps.machinesUndoTooltip' | translate"
              (click)="resetMachines($event)"
            ></button>
          }
        </div>
      </th>
      <!-- Beacons -->
      @if (columnsState().beacons.show) {
        <th colspan="2">
          <div class="d-flex align-items-center">
            <span>{{ 'options.column.beacons' | translate }}</span>
            @if (recipesModified().beacons) {
              <button
                pButton
                pRipple
                type="button"
                class="ms-2 p-button-text p-button-rounded"
                icon="fa-solid fa-rotate-left"
                [pTooltip]="'steps.beaconsUndoTooltip' | translate"
                (click)="resetBeacons()"
              ></button>
            }
          </div>
        </th>
      }
      <!-- Power -->
      @if (columnsState().power.show) {
        <th pSortableColumn="power">
          <div class="d-flex align-items-center justify-content-end">
            <span>{{ 'options.column.power' | translate }}</span>
            @if (!focus()) {
              <p-sortIcon field="power"></p-sortIcon>
            }
          </div>
        </th>
      }
      <!-- Pollution -->
      @if (columnsState().pollution.show) {
        <th pSortableColumn="pollution">
          <div class="d-flex align-items-center justify-content-end">
            <span>{{ dispRateInfo().pollutionLabel | translate }}</span>
            @if (!focus()) {
              <p-sortIcon field="pollution"></p-sortIcon>
            }
          </div>
        </th>
      }
      <!-- Link -->
      @if (columnsState().link.show) {
        <th></th>
      }
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-_step let-expanded="expanded">
    @if (_step | asStep; as step) {
      <tr>
        <!-- Expand row -->
        <td class="w-0 px-0 px-sm-1">
          <div [id]="'step_' + step.id" class="fragment"></div>
          @for (item of stepDetails()[step.id].tabs; track item.id) {
            <div
              [id]="'step_' + step.id + '_' + item.label"
              class="fragment"
            ></div>
          }
          <div class="d-flex">
            <button
              pButton
              pRipple
              type="button"
              class="p-button-text p-button-rounded transition-ease"
              [class.fa-rotate-90]="expanded"
              icon="fa-solid fa-angle-right"
              [pTooltip]="
                (expanded ? 'steps.hideDetails' : 'steps.showDetails')
                  | translate
              "
              [pRowToggler]="step"
              (click)="expandRow(step, expanded)"
            ></button>
          </div>
        </td>
        <!-- Checkbox -->
        @if (!focus() && columnsState().checkbox.show) {
          <td class="px-0 px-sm-2">
            <div class="d-flex justify-content-center">
              <p-checkbox
                [binary]="true"
                [ngModel]="step.checked"
                (onChange)="changeStepChecked(step, $event.checked)"
              ></p-checkbox>
            </div>
          </td>
        }
        <!-- Tree -->
        @if (!focus() && columnsState().tree.show) {
          <td class="overflow-hidden px-0 px-sm-1 py-0">
            <div class="d-flex align-items-center links">
              @if (!stepsTable.sortField && stepTree()[step.id]?.length) {
                @for (
                  trail of stepTree()[step.id];
                  track $index;
                  let last = $last
                ) {
                  <div
                    class="connect"
                    [class.trail]="trail"
                    [class.last]="last"
                  ></div>
                }
                <div class="indent"></div>
              }
              <div class="icon">
                @if (step.itemId && step.recipeObjectiveId == null) {
                  <button
                    pButton
                    pRipple
                    type="button"
                    class="hover-action p-button-text"
                    [class.hover-active]="
                      settings().excludedItemIds.has(step.itemId)
                    "
                    [icon]="step.itemId | iconSmClass"
                    [pTooltip]="tooltip"
                    (click)="
                      changeItemExcluded(
                        step.itemId,
                        !settings().excludedItemIds.has(step.itemId)
                      )
                    "
                  >
                    <i class="hover-icon fa-solid fa-eye-slash"></i>
                    <ng-template #tooltip>
                      <lab-tooltip [id]="step.itemId"></lab-tooltip>
                    </ng-template>
                  </button>
                } @else {
                  <i
                    [class]="step.recipeId | iconSmClass: 'recipe'"
                    [pTooltip]="tooltip"
                  >
                    @if (step.recipeObjectiveId != null) {
                      <span>#{{ step.recipeObjectiveId }}</span>
                    }
                    <ng-template #tooltip>
                      @if (step.recipeId) {
                        <lab-tooltip
                          [id]="step.recipeId"
                          type="recipe"
                          [adjustedRecipe]="step.recipe"
                        ></lab-tooltip>
                      }
                    </ng-template>
                  </i>
                }
              </div>
            </div>
          </td>
        }
        <!-- Items (Value / Icon) -->
        @if (step.itemId && step.items) {
          <td class="w-0 px-0 px-sm-2 text-end">
            @if (step.surplus && step.surplus.nonzero()) {
              <span class="monospace error-text"
                >(+{{ step.surplus | rate: columnsState().items.precision }})
              </span>
            }
            <span class="monospace">{{
              step.items.sub(step.surplus ?? rational.zero)
                | rate: columnsState().items.precision
            }}</span>
          </td>
          <td class="px-0 pe-sm-2">
            <div class="d-flex align-items-center">
              <span class="find-text">{{
                data().itemEntities[step.itemId].name
              }}</span>
              @if (
                !preferences().hideDuplicateIcons || !columnsState().tree.show
              ) {
                <button
                  pButton
                  pRipple
                  type="button"
                  class="hover-action p-button-text"
                  [class.hover-active]="
                    settings().excludedItemIds.has(step.itemId)
                  "
                  [icon]="step.itemId | iconSmClass"
                  [pTooltip]="tooltip"
                  (click)="
                    changeItemExcluded(
                      step.itemId,
                      !settings().excludedItemIds.has(step.itemId)
                    )
                  "
                >
                  <i class="hover-icon fa-solid fa-eye-slash"></i>
                  <ng-template #tooltip>
                    <lab-tooltip [id]="step.itemId"></lab-tooltip>
                  </ng-template>
                </button>
              }
            </div>
          </td>
        } @else {
          <td colspan="2"></td>
        }
        <!-- Belts -->
        @if (columnsState().belts.show) {
          @if (
            step.itemId && step.belts && itemsState()[step.itemId];
            as itemSettings
          ) {
            @if (itemSettings.beltId; as beltId) {
              <td class="w-0 px-0 px-sm-2 text-end">
                <span class="monospace">{{
                  step.belts | rate: columnsState().belts.precision
                }}</span>
              </td>
              <td class="px-0 pe-sm-2">
                <div class="d-flex align-items-center">
                  <!-- Belt/Pipe dropdown -->
                  @if (
                    data().beltIds.includes(beltId)
                      ? 'belt'
                      : data().pipeIds.includes(beltId)
                        ? 'pipe'
                        : null;
                    as type
                  ) {
                    @let stack = data().itemEntities[step.itemId].stack;
                    @if (
                      data().flags.has('beltStack') &&
                      stack &&
                      stack.gt(rational.one)
                    ) {
                      <button
                        pButton
                        pRipple
                        type="button"
                        class="hover-action p-button-text"
                        [pTooltip]="tooltip"
                        (click)="beltPicker.show($event, stack, itemSettings)"
                      >
                        <i class="p-button-icon" [class]="beltId | iconSmClass">
                          @if (itemSettings.stack?.gt(rational.one)) {
                            <span>{{ itemSettings.stack }}</span>
                          }
                        </i>
                        <i class="hover-icon fa-solid fa-gear"></i>
                      </button>
                      <lab-belt-overlay
                        #beltPicker
                        (setValue)="
                          changeBelts(step, $event, itemSettings.defaultBeltId)
                        "
                      ></lab-belt-overlay>
                    } @else {
                      <p-dropdown
                        labDropdownBase="icon"
                        [pTooltip]="tooltip"
                        [ngModel]="beltId"
                        [options]="
                          type === 'belt' ? options().belts : options().pipes
                        "
                        (onChange)="
                          itemsSvc.updateEntityField(
                            step.itemId,
                            'beltId',
                            $event.value,
                            itemSettings.defaultBeltId
                          )
                        "
                      >
                        <ng-template pTemplate="selectedItem" let-item>
                          @if (item) {
                            <div class="d-flex">
                              <i [class]="item.value | iconSmClass"></i>
                            </div>
                          }
                        </ng-template>
                        <ng-template pTemplate="item" let-item>
                          <div
                            class="d-flex align-items-center py-2 w-100 h-100"
                            [pTooltip]="tooltip"
                          >
                            <i [class]="item.value | iconSmClass"></i>
                            <div class="ms-3 text-truncate">
                              {{ item.label }}
                            </div>
                            <ng-template #tooltip>
                              <lab-tooltip
                                [id]="item.value"
                                [type]="$any(type)"
                              ></lab-tooltip>
                            </ng-template>
                          </div>
                        </ng-template>
                      </p-dropdown>
                    }
                    <ng-template #tooltip>
                      <lab-tooltip
                        [id]="beltId"
                        [type]="$any(type)"
                      ></lab-tooltip>
                    </ng-template>
                  } @else {
                    <!-- Pipe icon only -->
                    <i [class]="beltId | iconClass" [pTooltip]="tooltip">
                      <ng-template #tooltip>
                        <lab-tooltip [id]="beltId" type="pipe"></lab-tooltip>
                      </ng-template>
                    </i>
                  }
                </div>
              </td>
            }
          } @else {
            <td colspan="2"></td>
          }
        }
        <!-- Wagons -->
        @if (columnsState().wagons.show) {
          @if (step.itemId && step.wagons) {
            @if (itemsState()[step.itemId].wagonId; as wagonId) {
              <td class="w-0 px-0 px-sm-2 text-end">
                <span class="monospace">{{
                  step.wagons | rate: columnsState().wagons.precision
                }}</span>
              </td>
              <td class="px-0 pe-sm-2">
                <div class="d-flex align-items-center">
                  <!-- Wagon dropdown -->
                  @if (
                    data().cargoWagonIds.includes(wagonId)
                      ? 'cargo-wagon'
                      : data().fluidWagonIds.includes(wagonId)
                        ? 'fluid-wagon'
                        : null;
                    as type
                  ) {
                    <p-dropdown
                      labDropdownBase="icon"
                      [pTooltip]="tooltip"
                      [ngModel]="wagonId"
                      [options]="
                        type === 'cargo-wagon'
                          ? options().cargoWagons
                          : options().fluidWagons
                      "
                      (onChange)="
                        itemsSvc.updateEntityField(
                          step.itemId,
                          'wagonId',
                          $event.value,
                          itemsState()[step.itemId].defaultWagonId
                        )
                      "
                    >
                      <ng-template pTemplate="selectedItem" let-item>
                        @if (item) {
                          <div class="d-flex">
                            <i [class]="item.value | iconSmClass"></i>
                          </div>
                        }
                      </ng-template>
                      <ng-template pTemplate="item" let-item>
                        <div
                          class="d-flex align-items-center py-2 w-100 h-100"
                          [pTooltip]="tooltip"
                        >
                          <i [class]="item.value | iconSmClass"></i>
                          <div class="ms-3 text-truncate">
                            {{ item.label }}
                          </div>
                          <ng-template #tooltip>
                            <lab-tooltip
                              [id]="item.value"
                              [type]="$any(type)"
                            ></lab-tooltip>
                          </ng-template>
                        </div>
                      </ng-template>
                      <ng-template #tooltip>
                        <lab-tooltip
                          [id]="wagonId"
                          [type]="$any(type)"
                        ></lab-tooltip>
                      </ng-template>
                    </p-dropdown>
                  }
                </div>
              </td>
            }
          } @else {
            <td colspan="2"></td>
          }
        }
        <!-- Machines -->
        @if (step.recipeSettings?.machineId; as machineId) {
          <td class="w-0 px-0 px-sm-2 text-end">
            @if (
              step.machines &&
              step.machines.nonzero() &&
              !data().machineEntities[machineId].hideRate
            ) {
              <span class="monospace">{{
                step.machines
                  | machineRate: columnsState().machines.precision : machineId
              }}</span>
            }
          </td>
          <td class="px-0 pe-sm-2">
            @if (step.recipeId && step.recipe && step.recipeSettings) {
              <div class="d-flex align-items-center">
                <span class="find-text">{{ step.recipe.name }}</span>
                @if (
                  !preferences().hideDuplicateIcons ||
                  (step.itemId != null && step.itemId !== step.recipeId)
                ) {
                  <ng-container
                    *ngTemplateOutlet="recipesSelect"
                  ></ng-container>
                }
                @if (!step.recipe.flags.has('hideProducer')) {
                  <p-dropdown
                    labDropdownBase="icon"
                    [pTooltip]="tooltip"
                    [options]="step.recipeSettings.machineOptions"
                    [ngModel]="machineId"
                    (onChange)="
                      step.recipeObjectiveId
                        ? objectivesSvc.updateEntityField(
                            step.recipeObjectiveId,
                            'machineId',
                            $event.value,
                            step.recipeSettings.defaultMachineId
                          )
                        : recipesSvc.updateEntityField(
                            step.recipeId,
                            'machineId',
                            $event.value,
                            step.recipeSettings.defaultMachineId
                          )
                    "
                  >
                    <ng-template pTemplate="selectedItem" let-item>
                      @if (item) {
                        <div class="d-flex">
                          <i [class]="item.value | iconSmClass"></i>
                        </div>
                      }
                    </ng-template>
                    <ng-template pTemplate="item" let-item>
                      <div
                        class="d-flex align-items-center py-2 w-100 h-100"
                        [pTooltip]="tooltip"
                      >
                        <i [class]="item.value | iconSmClass"></i>
                        <div class="ms-3 text-truncate">
                          {{ item.label }}
                        </div>
                        <ng-template #tooltip>
                          <lab-tooltip
                            [id]="item.value"
                            type="machine"
                          ></lab-tooltip>
                        </ng-template>
                      </div>
                    </ng-template>
                    <ng-template #tooltip>
                      <lab-tooltip
                        [id]="machineId"
                        type="machine"
                      ></lab-tooltip>
                    </ng-template>
                  </p-dropdown>
                }
                @if (data().flags.has('overclock')) {
                  <p-inputNumber
                    #overclockInput
                    suffix="%"
                    [min]="1"
                    [max]="250"
                    [step]="10"
                    [maxFractionDigits]="2"
                    [size]="3"
                    inputStyleClass="text-end"
                    [pTooltip]="'steps.overclockTooltip' | translate"
                    [ngModel]="step.recipeSettings.overclock"
                    (onBlur)="
                      step.recipeObjectiveId
                        ? objectivesSvc.updateEntityField(
                            step.recipeObjectiveId,
                            'overclock',
                            rational(overclockInput.value ?? 100),
                            step.recipeSettings.defaultOverclock
                          )
                        : recipesSvc.updateEntityField(
                            step.recipeId,
                            'overclock',
                            rational(overclockInput.value ?? 100),
                            step.recipeSettings.defaultOverclock
                          )
                    "
                  >
                  </p-inputNumber>
                }
                @if (step.recipeSettings?.fuelId; as fuelId) {
                  @if (step.recipe.flags.has('burn')) {
                    <div class="d-flex align-items-center">
                      <i
                        class="padded"
                        [class]="fuelId | iconSmClass"
                        [pTooltip]="tooltip"
                      >
                        <ng-template #tooltip>
                          <lab-tooltip [id]="fuelId" type="fuel"></lab-tooltip>
                        </ng-template>
                      </i>
                    </div>
                  } @else if (step.recipeSettings.machineId) {
                    <p-dropdown
                      labDropdownBase="icon"
                      [pTooltip]="tooltip"
                      [ngModel]="fuelId"
                      [options]="step.recipeSettings.fuelOptions ?? []"
                      (onChange)="
                        step.recipeObjectiveId
                          ? objectivesSvc.updateEntityField(
                              step.recipeObjectiveId,
                              'fuelId',
                              $event.value,
                              step.recipeSettings.fuelId
                            )
                          : recipesSvc.updateEntityField(
                              step.recipeId,
                              'fuelId',
                              $event.value,
                              step.recipeSettings.defaultFuelId
                            )
                      "
                    >
                      <ng-template pTemplate="selectedItem" let-item>
                        <div class="d-flex">
                          <i [class]="item.value | iconSmClass"></i>
                        </div>
                      </ng-template>
                      <ng-template pTemplate="item" let-item>
                        <div
                          class="d-flex align-items-center py-2 w-100 h-100"
                          [pTooltip]="tooltip"
                        >
                          <i [class]="item.value | iconSmClass"></i>
                          <div class="ms-3 text-truncate">
                            {{ item.label }}
                          </div>
                          <ng-template #tooltip>
                            <lab-tooltip
                              [id]="item.value"
                              type="fuel"
                            ></lab-tooltip>
                          </ng-template>
                        </div>
                      </ng-template>
                      <ng-template #tooltip>
                        <lab-tooltip [id]="fuelId" type="fuel"></lab-tooltip>
                      </ng-template>
                    </p-dropdown>
                  }
                }
                @if (step.recipeSettings?.modules; as modules) {
                  @if (data().machineEntities[machineId]; as machine) {
                    @if (machine.modules !== true && machine.modules?.isOne()) {
                      <p-dropdown
                        labDropdownBase="icon"
                        labNoDrag
                        [pTooltip]="'settings.modifierTooltip' | translate"
                        [ngModel]="modules[0].id"
                        [options]="step.recipeSettings.moduleOptions ?? []"
                        (onChange)="
                          changeModulesBeacons(step, {
                            modules: [
                              { id: $event.value, count: rational.one },
                            ],
                          })
                        "
                      >
                        <ng-template pTemplate="selectedItem" let-item>
                          <div class="d-flex">
                            <i [class]="item.value | iconSmClass"></i>
                          </div>
                        </ng-template>
                        <ng-template pTemplate="item" let-item>
                          <div
                            class="d-flex align-items-center py-2 w-100 h-100"
                            [pTooltip]="
                              item.value !== 'module' ? tooltip : undefined
                            "
                          >
                            <i [class]="item.value | iconSmClass"></i>
                            <div class="ms-3 text-truncate">
                              {{ item.label }}
                            </div>
                            <ng-template #tooltip>
                              <lab-tooltip
                                [id]="item.value"
                                type="module"
                              ></lab-tooltip>
                            </ng-template>
                          </div>
                        </ng-template>
                      </p-dropdown>
                    } @else if (machine.modules != null) {
                      <button
                        pButton
                        pRipple
                        type="button"
                        class="hover-action modules p-button-text"
                        [pTooltip]="tooltip"
                        (click)="
                          modulePicker.show(
                            $event,
                            modules,
                            machine,
                            step.recipeId
                          )
                        "
                      >
                        @for (module of modules; track module.id) {
                          <i
                            class="p-button-icon"
                            [class]="module.id | iconSmClass"
                            ><span>{{ module.count }}</span></i
                          >
                        }
                        <i class="hover-icon fa-solid fa-gear"></i>
                      </button>
                      <lab-modules-overlay
                        #modulePicker
                        (setValue)="
                          changeModulesBeacons(step, { modules: $event })
                        "
                      ></lab-modules-overlay>
                      <ng-template #tooltip>
                        @for (module of modules; track module.id) {
                          @if (module.id) {
                            <lab-tooltip
                              [id]="module.id"
                              type="module"
                            ></lab-tooltip>
                          }
                        }
                      </ng-template>
                    }
                  }
                }
              </div>
            }
          </td>
        } @else {
          <td></td>
          <td class="px-0 pe-sm-2">
            <ng-container *ngTemplateOutlet="recipesSelect"></ng-container>
          </td>
        }
        <ng-template #recipesSelect>
          @if (stepDetails()[step.id]; as details) {
            <p-multiSelect
              inputId="enabled-recipes"
              styleClass="icon"
              appendTo="body"
              scrollHeight="40vh"
              panelStyleClass="tooltip"
              [(ngModel)]="details.recipesEnabled"
              [options]="details.recipeOptions"
              [pTooltip]="tooltip"
              (onPanelHide)="
                changeRecipesIncluded(details.recipeIds, details.recipesEnabled)
              "
            >
              <ng-template #tooltip>
                @if (step.recipeId) {
                  <lab-tooltip
                    [id]="step.recipeId"
                    type="recipe"
                    [adjustedRecipe]="step.recipe"
                    [action]="'steps.selectRecipesTooltip' | translate"
                  ></lab-tooltip>
                } @else {
                  {{ 'steps.selectRecipesTooltip' | translate }}
                }
              </ng-template>
              <ng-template pTemplate="selectedItems" let-items>
                @if (step.recipeId) {
                  <div class="d-flex">
                    <i [class]="step.recipeId | iconSmClass: 'recipe'">
                      @if (step.recipeObjectiveId) {
                        <span>#{{ step.recipeObjectiveId }}</span>
                      }
                    </i>
                  </div>
                } @else {
                  <i class="fa-solid fa-flask-vial"></i>
                }
              </ng-template>
              <ng-template pTemplate="item" let-item>
                <div
                  class="d-flex align-items-center p-2 w-100 h-100"
                  [pTooltip]="tooltip"
                >
                  <i [class]="item.value | iconSmClass: 'recipe'"></i>
                  <div class="ms-3 text-truncate">
                    {{ item.label }}
                  </div>
                  <ng-template #tooltip>
                    <lab-tooltip [id]="item.value" type="recipe"></lab-tooltip>
                  </ng-template>
                </div>
              </ng-template>
            </p-multiSelect>
          }
        </ng-template>
        <!-- Beacons -->
        @if (columnsState().beacons.show) {
          <td colspan="2" class="px-0 px-sm-2">
            @if (
              step.recipeId &&
              step.recipeSettings &&
              step.recipeSettings.beacons &&
              step.recipeSettings.beacons.length
            ) {
              <button
                pButton
                pRipple
                type="button"
                class="hover-action icons p-button-text flex-column"
                [pTooltip]="tooltip"
                (click)="
                  beaconsOverlay.show($event, step.recipeSettings.beacons)
                "
              >
                @for (beacon of step.recipeSettings.beacons; track $index) {
                  <div class="d-flex">
                    <i class="p-button-icon" [class]="beacon.id | iconSmClass"
                      ><span>{{ beacon.count }}</span></i
                    >
                    @if (beacon.total) {
                      <i
                        class="p-button-icon sum"
                        [class]="beacon.id | iconSmClass"
                        ><span>{{ beacon.total }}</span></i
                      >
                    }
                    @for (module of beacon.modules; track module.id) {
                      <i class="p-button-icon" [class]="module.id | iconSmClass"
                        ><span>{{ module.count }}</span></i
                      >
                    }
                  </div>
                }
                <i class="hover-icon fa-solid fa-gear"></i>
              </button>
              <lab-beacons-overlay
                #beaconsOverlay
                (setValue)="changeModulesBeacons(step, { beacons: $event })"
              ></lab-beacons-overlay>
              <ng-template #tooltip>
                @if (step.recipeSettings.beacons?.[0]?.id; as beaconId) {
                  <lab-tooltip [id]="beaconId" type="beacon"></lab-tooltip>
                }
              </ng-template>
            }
          </td>
        }
        <!-- Power -->
        @if (columnsState().power.show) {
          <td class="px-0 px-sm-2 text-end">
            @if (step.power && step.power.nonzero()) {
              <span class="monospace">{{
                step.power
                  | power: columnsState().power.precision : effectivePowerUnit()
              }}</span>
            }
          </td>
        }
        <!-- Pollution -->
        @if (columnsState().pollution.show) {
          <td class="px-0 px-sm-2 text-end">
            @if (step.pollution && step.pollution.nonzero()) {
              <span class="monospace">{{
                step.pollution | rate: columnsState().pollution.precision
              }}</span>
            }
          </td>
        }
        <!-- Link -->
        @if (columnsState().link.show) {
          <td class="w-0 px-0 ps-sm-1">
            <div class="d-flex">
              <a
                class="text-decoration-none"
                target="_blank"
                routerLink="."
                [queryParams]="step | stepHref: routerSvc.zipConfig() | async"
              >
                <button
                  pButton
                  pRipple
                  type="button"
                  class="p-button-text p-button-rounded"
                  icon="fa-solid fa-arrow-up-right-from-square"
                  [pTooltip]="'steps.openNewTabTooltip' | translate"
                  tooltipPosition="left"
                ></button>
              </a>
              @if (
                (step.recipeId && stepsModified().recipes[step.recipeId]) ||
                (step.itemId && stepsModified().items[step.itemId]) ||
                (step.recipeObjectiveId &&
                  stepsModified().objectives[step.recipeObjectiveId])
              ) {
                <button
                  pButton
                  pRipple
                  type="button"
                  class="p-button-text p-button-rounded"
                  icon="fa-solid fa-rotate-left"
                  [pTooltip]="'steps.stepUndoTooltip' | translate"
                  tooltipPosition="left"
                  (click)="resetStep(step)"
                ></button>
              }
            </div>
          </td>
        }
      </tr>
    }
  </ng-template>
  <ng-template pTemplate="rowexpansion" let-_step>
    <!-- Details row tab menu -->
    @if (_step | asStep; as step) {
      <tr class="detail tabs">
        <td class="px-1">
          <a
            class="text-decoration-none"
            routerLink="."
            [relativeTo]="route"
            queryParamsHandling="preserve"
            [fragment]="step.id"
          >
            <button
              pButton
              pRipple
              type="button"
              class="p-button-text p-button-rounded"
              icon="fa-solid fa-link"
            ></button>
          </a>
        </td>
        <td colspan="100">
          <p-tabMenu
            #expandTabMenu
            [model]="stepDetails()[step.id].tabs"
            [activeItem]="activeItem[step | stepId]"
            (activeItemChange)="setActiveItem(step, $event)"
          >
            <ng-template pTemplate="item" let-item>
              <a class="p-menuitem-link" [id]="item.id">
                <span
                  class="p-menuitem-icon"
                  [class]="$any(stepDetailIcon)[item.label]"
                ></span>
                <span class="p-menuitem-text">{{
                  'options.stepDetailTab.' + item.label | translate
                }}</span>
              </a>
            </ng-template>
          </p-tabMenu>
        </td>
      </tr>
      @switch (expandTabMenu.activeItem?.label) {
        @case (StepDetailTab.Item) {
          <!-- Item row details -->
          @if (stepDetails()[step.id].outputs.length) {
            <tr class="detail">
              <ng-container *ngTemplateOutlet="leftPad"></ng-container>
              <td colspan="100" class="fw-bold">
                {{ 'steps.sources' | translate }}
              </td>
            </tr>
          }
          @for (output of stepDetails()[step.id].outputs; track $index) {
            @if (step.itemId) {
              <ng-container
                *ngTemplateOutlet="
                  detailRow;
                  context: {
                    items: step.items?.mul(output.value),
                    itemId: step.itemId,
                    belts: step.belts?.mul(output.value),
                    beltId: itemsState()[step.itemId].beltId,
                    wagons: step.wagons?.mul(output.value),
                    wagonId: itemsState()[step.itemId].wagonId,
                    machines: output.step?.machines,
                    machineId: output.step?.recipeSettings?.machineId,
                    recipeId: output.step?.recipeId,
                    recipeObjectiveId: output.step?.recipeObjectiveId,
                    percent: output.value,
                    percentOnDest: true,
                    destId: step.itemId,
                    inputs: output.inputs,
                  }
                "
              >
              </ng-container>
            }
          }
          @if (step.parents) {
            <tr class="detail">
              <ng-container *ngTemplateOutlet="leftPad"></ng-container>
              <td colspan="100" class="fw-bold">
                {{ 'steps.destinations' | translate }}
              </td>
            </tr>
          }
          @for (
            parent of step.parents | keyvalue: trackSvc.sortByValue;
            track parent.key
          ) {
            @if (step.itemId) {
              <ng-container
                *ngTemplateOutlet="
                  detailRow;
                  context: {
                    items: step.items?.mul(parent.value),
                    itemId: step.itemId,
                    belts: step.belts?.mul(parent.value),
                    beltId: itemsState()[step.itemId].beltId,
                    wagons: step.wagons?.mul(parent.value),
                    wagonId: itemsState()[step.itemId].wagonId,
                    machines:
                      stepDetails()[step.id].outputs.length === 1
                        ? step.machines?.mul(parent.value)
                        : null,
                    machineId:
                      stepDetails()[step.id].outputs.length === 1
                        ? step.recipeSettings?.machineId
                        : null,
                    recipeId: step.recipeId,
                    recipeObjectiveId: step.recipeObjectiveId,
                    percent: parent.value,
                    destId: stepById()[parent.key]?.recipeId,
                    destRecipeObjectiveId:
                      stepById()[parent.key]?.recipeObjectiveId,
                    destIsRecipe: true,
                    outputs: parent.key === '',
                  }
                "
              >
              </ng-container>
            }
          }
        }
        @case (StepDetailTab.Recipe) {
          <!-- Recipe row details -->
          @if (step.recipe) {
            @if (
              data().flags.has('miningDepletion') &&
              step.recipe.flags.has('mining')
            ) {
              <tr class="detail">
                <ng-container *ngTemplateOutlet="leftPad"></ng-container>
                <td colspan="100" class="fw-bold">
                  {{ 'steps.depletion' | translate }}
                </td>
              </tr>
              @for (
                output of step.outputs | keyvalue: trackSvc.sortByValue;
                track output.key
              ) {
                @if (stepByItemEntities()[output.key]; as rowStep) {
                  @if (
                    rowStep.items && step.outputs?.[output.key];
                    as rowPercent
                  ) {
                    <ng-container
                      *ngTemplateOutlet="
                        detailRow;
                        context: {
                          items: rowStep.items
                            .mul(rowPercent)
                            .div(step.recipe.effects.productivity),
                          itemId: output.key,
                        }
                      "
                    >
                    </ng-container>
                  }
                }
              }
            }
            @if ((step.recipe.in | keyvalue).length) {
              <tr class="detail">
                <ng-container *ngTemplateOutlet="leftPad"></ng-container>
                <td colspan="100" class="fw-bold">
                  {{ 'steps.inputs' | translate }}
                </td>
              </tr>
              @for (
                input of step.recipe.in | keyvalue: trackSvc.sortByValue;
                track input.key
              ) {
                @if (stepByItemEntities()[input.key]; as rowStep) {
                  @if (
                    rowStep.itemId && rowStep.parents?.[step.id];
                    as rowPercent
                  ) {
                    @if (
                      stepDetails()[rowStep.id].outputs.length === 1 &&
                        stepDetails()[rowStep.id].outputs[0];
                      as output
                    ) {
                      <ng-container
                        *ngTemplateOutlet="
                          detailRow;
                          context: {
                            items: rowStep.items?.mul(rowPercent),
                            itemId: input.key,
                            belts: rowStep.belts?.mul(rowPercent),
                            beltId: itemsState()[rowStep.itemId].beltId,
                            wagons: rowStep.wagons?.mul(rowPercent),
                            wagonId: itemsState()[rowStep.itemId].wagonId,
                            machines: output.step?.machines?.mul(rowPercent),
                            machineId: output.step?.recipeSettings?.machineId,
                            recipeId: output.step?.recipeId,
                            recipeObjectiveId: output.step?.recipeObjectiveId,
                            percent: rowPercent,
                            destId: step.recipeId,
                            destRecipeObjectiveId: step.recipeObjectiveId,
                            destIsRecipe: true,
                          }
                        "
                      >
                      </ng-container>
                    } @else {
                      <ng-container
                        *ngTemplateOutlet="
                          detailRow;
                          context: {
                            items: rowStep.items?.mul(rowPercent),
                            itemId: input.key,
                            belts: rowStep.belts?.mul(rowPercent),
                            beltId: itemsState()[rowStep.itemId].beltId,
                            wagons: rowStep.wagons?.mul(rowPercent),
                            wagonId: itemsState()[rowStep.itemId].wagonId,
                            percent: rowPercent,
                            destId: step.recipeId,
                            destRecipeObjectiveId: step.recipeObjectiveId,
                            destIsRecipe: true,
                          }
                        "
                      >
                      </ng-container>
                    }
                  }
                }
              }
            }
            <tr class="detail">
              <ng-container *ngTemplateOutlet="leftPad"></ng-container>
              <td colspan="100" class="fw-bold">
                {{ 'steps.time' | translate }}
              </td>
            </tr>
            <tr class="detail">
              <ng-container *ngTemplateOutlet="leftPad"></ng-container>
              <td class="w-0 text-end">
                <span class="monospace">{{
                  step.recipe.time | rate: columnsState().items.precision
                }}</span>
              </td>
              <td class="ps-0">
                <div class="d-flex"><i class="lab-icon time"></i></div>
              </td>
              <td colspan="100"></td>
            </tr>
            <tr class="detail">
              <ng-container *ngTemplateOutlet="leftPad"></ng-container>
              <td colspan="100" class="fw-bold">
                {{ 'steps.outputs' | translate }}
              </td>
            </tr>
            @for (
              output of step.recipe.out | keyvalue: trackSvc.sortByValue;
              track output.key
            ) {
              @if (stepByItemEntities()[output.key]; as rowStep) {
                @if (
                  rowStep.itemId && step.outputs?.[output.key];
                  as rowPercent
                ) {
                  <ng-container
                    *ngTemplateOutlet="
                      detailRow;
                      context: {
                        items: rowStep.items?.mul(rowPercent),
                        itemId: output.key,
                        belts: rowStep.belts?.mul(rowPercent),
                        beltId: itemsState()[rowStep.itemId].beltId,
                        wagons: rowStep.wagons?.mul(rowPercent),
                        wagonId: itemsState()[rowStep.itemId].wagonId,
                        machines: step.machines,
                        machineId: step.recipeSettings?.machineId,
                        recipeId: step.recipeId,
                        recipeObjectiveId: step.recipeObjectiveId,
                        percent: rowPercent,
                        percentOnDest: true,
                        destId: output.key,
                        destRecipeObjectiveId: step.recipeObjectiveId,
                      }
                    "
                  >
                  </ng-container>
                }
              }
            }
          }
        }
        @case (StepDetailTab.Machine) {
          <!-- Machine row details -->
          <tr class="detail">
            <td></td>
            <td colspan="100">
              @if (step.recipeId && step.recipe && step.machines) {
                <div class="d-flex align-items-center">
                  <table class="mw-0">
                    @for (
                      input of step.recipe.in | keyvalue: trackSvc.sortByValue;
                      track input.key
                    ) {
                      @if (stepByItemEntities()[input.key]; as rowStep) {
                        @if (rowStep.parents?.[step.id]; as rowPercent) {
                          <tr>
                            <td>
                              @if (rowStep.items) {
                                <ng-container
                                  *ngTemplateOutlet="
                                    machineValueCell;
                                    context: {
                                      value:
                                        rowStep.items
                                          .mul(rowPercent)
                                          .div(step.machines)
                                        | rate: columnsState().items.precision,
                                      itemId: input.key,
                                    }
                                  "
                                >
                                </ng-container>
                              }
                            </td>
                            @if (columnsState().belts.show) {
                              <td>
                                @if (rowStep.belts) {
                                  @if (
                                    itemsState()[input.key].beltId;
                                    as beltId
                                  ) {
                                    <ng-container
                                      *ngTemplateOutlet="
                                        machineValueCell;
                                        context: {
                                          value:
                                            rowStep.belts
                                              .mul(rowPercent)
                                              .div(step.machines)
                                            | rate
                                              : columnsState().belts.precision,
                                          itemId: beltId,
                                        }
                                      "
                                    >
                                    </ng-container>
                                  }
                                }
                              </td>
                            }
                            @if (data().flags.has('inserterEstimation')) {
                              <td>
                                @if (
                                  data().itemEntities[input.key].stack &&
                                  rowStep.items
                                ) {
                                  @if (
                                    rowStep.items
                                      .mul(rowPercent)
                                      .div(step.machines)
                                      .div(dispRateInfo().value)
                                      | inserterSpeed: settings();
                                    as ins
                                  ) {
                                    <ng-container
                                      *ngTemplateOutlet="
                                        machineValueCell;
                                        context: {
                                          value: ins.value | rate: 1,
                                          itemId: ins.id,
                                        }
                                      "
                                    >
                                    </ng-container>
                                  }
                                }
                              </td>
                            }
                          </tr>
                        }
                      }
                    }
                  </table>
                  @if ((step.recipe.in | keyvalue).length) {
                    <i class="fa-solid fa-arrow-right mx-3"></i>
                  }
                  <table class="mw-0">
                    <tr>
                      <td class="w-0 text-end">
                        <span class="monospace">{{
                          rational.one | rate: columnsState().machines.precision
                        }}</span>
                      </td>
                      <td>
                        @if (step.recipeSettings?.machineId; as machineId) {
                          <div class="d-flex align-items-center">
                            <i
                              [class]="step.recipeId | iconClass: 'recipe'"
                              [pTooltip]="tooltip"
                            >
                              <ng-template #tooltip>
                                <lab-tooltip [id]="step.recipeId" type="recipe">
                                </lab-tooltip>
                              </ng-template>
                            </i>
                            <i
                              [class]="machineId | iconClass"
                              [pTooltip]="tooltip"
                            >
                              <ng-template #tooltip>
                                <lab-tooltip
                                  [id]="machineId"
                                  type="machine"
                                ></lab-tooltip>
                              </ng-template>
                            </i>
                          </div>
                        }
                      </td>
                    </tr>
                    <tr>
                      <td class="w-0 text-end">
                        <span class="monospace">{{
                          dispRateInfo().value
                            | rate: columnsState().machines.precision
                        }}</span>
                      </td>
                      <td><i class="lab-icon time"></i></td>
                    </tr>
                  </table>
                  <i class="fa-solid fa-arrow-right mx-3"></i>
                  <table class="mw-0">
                    @for (
                      output of step.recipe.out
                        | keyvalue: trackSvc.sortByValue;
                      track output.key
                    ) {
                      @if (output.value.div(step.recipe.time); as items) {
                        <tr>
                          @if (data().flags.has('inserterEstimation')) {
                            <td>
                              @if (data().itemEntities[output.key].stack) {
                                @if (
                                  items | inserterSpeed: settings();
                                  as ins
                                ) {
                                  <ng-container
                                    *ngTemplateOutlet="
                                      machineValueCell;
                                      context: {
                                        value: ins.value | rate: 1,
                                        itemId: ins.id,
                                      }
                                    "
                                  >
                                  </ng-container>
                                }
                              }
                            </td>
                          }
                          @if (columnsState().belts.show) {
                            <td>
                              @if (itemsState()[output.key].beltId; as beltId) {
                                <ng-container
                                  *ngTemplateOutlet="
                                    machineValueCell;
                                    context: {
                                      value:
                                        items.div(beltSpeed()[beltId])
                                        | rate: columnsState().belts.precision,
                                      itemId: beltId,
                                    }
                                  "
                                >
                                </ng-container>
                              }
                            </td>
                          }
                          <td>
                            <ng-container
                              *ngTemplateOutlet="
                                machineValueCell;
                                context: {
                                  value:
                                    items.mul(dispRateInfo().value)
                                    | rate: columnsState().items.precision,
                                  itemId: output.key,
                                }
                              "
                            >
                            </ng-container>
                          </td>
                        </tr>
                      }
                    }
                  </table>
                  <ng-template
                    #machineValueCell
                    let-value="value"
                    let-itemId="itemId"
                  >
                    <div class="d-flex align-items-center justify-content-end">
                      <span class="monospace">{{ value }}</span>
                      <i [class]="itemId | iconClass" [pTooltip]="tooltip">
                        <ng-template #tooltip>
                          <lab-tooltip [id]="itemId"></lab-tooltip>
                        </ng-template>
                      </i>
                    </div>
                  </ng-template>
                </div>
              }
              @if (data().flags.has('inserterEstimation')) {
                <small
                  [innerHTML]="'steps.inserterCountInfo' | translate"
                ></small>
              }
            </td>
          </tr>
        }
        @case (StepDetailTab.Recipes) {
          <tr class="detail">
            <td></td>
            <td colspan="100" class="py-4">
              This functionality has been moved. The recipe icon in the machines
              column now opens a multiselect dropdown to select enabled recipes.
            </td>
          </tr>
        }
      }
    }
  </ng-template>
  <ng-template pTemplate="emptymessage">
    @if (focus()) {
      <tr>
        <td colspan="100">
          <div class="d-flex justify-content-center">
            <span>{{ 'steps.emptyMessage' | translate }}</span>
          </div>
        </td>
      </tr>
    }
  </ng-template>
  <ng-template #emptyCol2>
    <td colspan="2"></td>
  </ng-template>
  <ng-template #leftPad>
    <td></td>
    @if (!focus()) {
      @if (columnsState().checkbox.show) {
        <td></td>
      }
      @if (columnsState().tree.show) {
        <td></td>
      }
    }
  </ng-template>
  <ng-template
    #detailRow
    let-items="items"
    let-itemId="itemId"
    let-belts="belts"
    let-beltId="beltId"
    let-wagons="wagons"
    let-wagonId="wagonId"
    let-machines="machines"
    let-machineId="machineId"
    let-recipeId="recipeId"
    let-recipeObjectiveId="recipeObjectiveId"
    let-percent="percent"
    let-percentOnDest="percentOnDest"
    let-destId="destId"
    let-destRecipeObjectiveId="destRecipeObjectiveId"
    let-destIsRecipe="destIsRecipe"
    let-inputs="inputs"
    let-outputs="outputs"
  >
    <tr class="detail">
      @if (itemId) {
        <ng-container *ngTemplateOutlet="leftPad"></ng-container>
        <td class="w-0 text-end">
          <span class="monospace">{{
            items | rate: columnsState().items.precision
          }}</span>
        </td>
        <td class="ps-0">
          <div class="d-flex">
            <i [class]="itemId | iconClass" [pTooltip]="tooltip">
              <ng-template #tooltip>
                <lab-tooltip [id]="itemId"></lab-tooltip>
              </ng-template>
            </i>
          </div>
        </td>
        @if (columnsState().belts.show && belts && beltId) {
          <td class="w-0 text-end">
            <span class="monospace">{{
              belts | rate: columnsState().belts.precision
            }}</span>
          </td>
          <td class="ps-0">
            <div class="d-flex">
              <i [class]="beltId | iconClass" [pTooltip]="tooltip">
                <ng-template #tooltip>
                  <lab-tooltip [id]="beltId" type="belt"></lab-tooltip>
                </ng-template>
              </i>
            </div>
          </td>
        }
        @if (columnsState().wagons.show && wagons && wagonId) {
          <td class="w-0 text-end">
            <span class="monospace">{{
              wagons | rate: columnsState().wagons.precision
            }}</span>
          </td>
          <td class="ps-0">
            <div class="d-flex">
              @if (data().cargoWagonIds.includes(wagonId)) {
                <i [class]="wagonId | iconClass" [pTooltip]="tooltip">
                  <ng-template #tooltip>
                    <lab-tooltip
                      [id]="wagonId"
                      type="cargo-wagon"
                    ></lab-tooltip>
                  </ng-template>
                </i>
              } @else {
                <i [class]="wagonId | iconClass" [pTooltip]="tooltip">
                  <ng-template #tooltip>
                    <lab-tooltip
                      [id]="wagonId"
                      type="fluid-wagon"
                    ></lab-tooltip>
                  </ng-template>
                </i>
              }
            </div>
          </td>
        }
        <td class="w-0 text-end">
          @if (
            machines &&
            machines.nonzero() &&
            !data().machineEntities[machineId].hideRate
          ) {
            <span class="monospace">{{
              machines
                | machineRate: columnsState().machines.precision : machineId
            }}</span>
          }
        </td>
        <td class="p-0" colspan="100">
          <div class="d-flex align-items-center">
            @if (inputs) {
              <div>
                {{ 'steps.inputs' | translate }}
              </div>
            }
            <i [class]="recipeId | iconClass: 'recipe'" [pTooltip]="tooltipObj">
              @if (recipeObjectiveId) {
                <span>#{{ recipeObjectiveId }}</span>
              }
              <ng-template #tooltipObj>
                <lab-tooltip [id]="recipeId" type="recipe"></lab-tooltip>
              </ng-template>
            </i>
            <i [class]="machineId | iconClass" [pTooltip]="tooltipMach">
              <ng-template #tooltipMach>
                <lab-tooltip [id]="machineId" type="machine"></lab-tooltip>
              </ng-template>
            </i>
            @if (percent) {
              @if (percentOnDest) {
                <i class="m-1 p-2 fa-solid fa-arrow-right"></i>
              }
              <span class="monospace">{{ percent | rate: -2 | leftPad }}%</span>
              @if (!percentOnDest) {
                <i class="m-1 p-2 fa-solid fa-arrow-right"></i>
              }
              @if (destId) {
                <i
                  [class]="
                    destId | iconClass: (destIsRecipe ? 'recipe' : 'item')
                  "
                  [pTooltip]="tooltip"
                >
                  @if (destRecipeObjectiveId) {
                    <span>#{{ destRecipeObjectiveId }}</span>
                  }
                  <ng-template #tooltip>
                    <lab-tooltip
                      [id]="destId"
                      [type]="destIsRecipe ? 'recipe' : 'item'"
                    ></lab-tooltip>
                  </ng-template>
                </i>
              }
              @if (outputs) {
                <span>
                  {{ 'steps.outputs' | translate }}
                </span>
              }
            }
          </div>
        </td>
      }
    </tr>
  </ng-template>
  <ng-template pTemplate="footer">
    @if (!focus()) {
      <tr>
        <td></td>
        @if (columnsState().checkbox.show) {
          <td></td>
        }
        @if (columnsState().tree.show) {
          <td></td>
        }
        <td colspan="2">
          {{ 'steps.total' | translate }}
        </td>
        <ng-container
          *ngTemplateOutlet="
            totalCell;
            context: {
              columnSettings: columnsState().belts,
              totals: totals().belts,
              type: 'belt',
            }
          "
        >
        </ng-container>
        <ng-container
          *ngTemplateOutlet="
            totalCell;
            context: {
              columnSettings: columnsState().wagons,
              totals: totals().wagons,
            }
          "
        >
        </ng-container>
        <ng-container
          *ngTemplateOutlet="
            totalCell;
            context: {
              columnSettings: columnsState().machines,
              totals: totals().machines,
              modulesTotals: totals().modules,
              type: 'machine',
            }
          "
        >
        </ng-container>
        <ng-container
          *ngTemplateOutlet="
            totalCell;
            context: {
              columnSettings: columnsState().beacons,
              totals: totals().beacons,
              modulesTotals: totals().beaconModules,
              type: 'beacon',
            }
          "
        >
        </ng-container>
        @if (columnsState().power.show) {
          <td class="text-end inherit">
            <span class="monospace">{{
              totals().power
                | power: columnsState().power.precision : effectivePowerUnit()
            }}</span>
          </td>
        }
        @if (columnsState().pollution.show) {
          <td class="text-end inherit">
            <span class="monospace">{{
              totals().pollution | rate: columnsState().pollution.precision
            }}</span>
          </td>
        }
        @if (columnsState().link.show) {
          <td></td>
        }
      </tr>
    }
    <ng-template
      #totalCell
      let-columnSettings="columnSettings"
      let-totals="totals"
      let-type="type"
      let-modulesTotals="modulesTotals"
    >
      @if (columnSettings.show) {
        <td class="w-0 text-end inherit">
          @for (tot of totals | keyvalue: trackSvc.sortByValue; track tot.key) {
            <div class="py-2 icon-height">
              <span class="monospace">{{
                tot.value | rate: columnSettings.precision
              }}</span>
            </div>
          }
        </td>
        <td class="ps-0 inherit">
          <div class="d-flex">
            <div class="d-flex flex-column justify-content-center">
              @for (
                tot of totals | keyvalue: trackSvc.sortByValue;
                track tot.key
              ) {
                @if (data().itemEntities[tot.key]) {
                  <i
                    class="d-block"
                    [class]="tot.key | iconClass"
                    [pTooltip]="tooltip"
                  >
                    <ng-template #tooltip>
                      <lab-tooltip [id]="tot.key" [type]="type"></lab-tooltip>
                    </ng-template>
                  </i>
                } @else {
                  <i
                    class="d-block"
                    [class]="tot.key | iconClass: 'recipe'"
                    [pTooltip]="tooltip"
                  >
                    <ng-template #tooltip>
                      <lab-tooltip [id]="tot.key" type="recipe"></lab-tooltip>
                    </ng-template>
                  </i>
                }
              }
            </div>
            <div class="modules-column">
              @for (
                tot of modulesTotals | keyvalue: trackSvc.sortByValue;
                track tot.key
              ) {
                <div class="p-2 icon-height text-end">
                  <span class="monospace">{{ tot.value }}</span>
                </div>
                <i
                  class="d-block"
                  [class]="tot.key | iconClass: 'item'"
                  [pTooltip]="tot.key !== 'module' ? tooltip : undefined"
                >
                  <ng-template #tooltip>
                    <lab-tooltip [id]="tot.key" type="module"></lab-tooltip>
                  </ng-template>
                </i>
              }
            </div>
          </div>
        </td>
      }
    </ng-template>
  </ng-template>
</p-table>
<lab-columns #columnsDlg></lab-columns>
