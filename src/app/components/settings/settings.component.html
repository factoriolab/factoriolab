<div class="p-3">
  <div class="d-flex align-items-center justify-content-between">
    <h2>{{ 'settings.header' | translate }}</h2>
    <div>
      <button
        pButton
        pRipple
        type="button"
        class="p-button-rounded p-button-text"
        icon="fa-solid fa-trash"
        [pTooltip]="'settings.reset' | translate"
        tooltipPosition="bottom"
        (click)="clickResetSettings()"
      ></button>
      <button
        pButton
        pRipple
        type="button"
        class="p-button-rounded p-button-text d-inline-flex d-none d-xl-inline-flex"
        icon="fa-solid fa-xmark"
        (click)="contentSvc.toggleSettingsXl()"
      ></button>
      <button
        pButton
        pRipple
        type="button"
        class="p-button-rounded p-button-text d-inline-flex d-sm-none"
        icon="fa-solid fa-xmark"
        (click)="contentSvc.toggleSettings()"
      ></button>
    </div>
  </div>
</div>
<div class="flex-grow-1 overflow-hidden">
  <p-scrollPanel styleClass="mb-5" [style]="{ height: '100%' }">
    <p-accordion [multiple]="true">
      <p-accordionTab>
        <ng-template pTemplate="header">
          <div
            class="d-flex align-items-center justify-content-between flex-grow-1"
          >
            <div>{{ 'settings.savedStates' | translate }}</div>
            @if (state) {
              <div>{{ state }}</div>
            }
          </div>
        </ng-template>
        @if (isStandalone) {
          <div class="p-inputgroup mb-2">
            <button
              pButton
              pRipple
              type="button"
              class="p-button-outlined"
              icon="fa-solid fa-arrow-up-right-from-square"
              (click)="setSearch(search.value)"
            ></button>
            <input #search pInputText type="text" [ngModel]="search" />
            <button
              pButton
              pRipple
              type="button"
              class="p-button-outlined"
              icon="fa-solid fa-copy"
              (click)="copySearchToClipboard(search.value)"
            ></button>
          </div>
        }
        @if (editState) {
          <div class="p-inputgroup mb-2">
            <input
              #nameCtrl="ngModel"
              pInputText
              pAutoFocus
              type="text"
              [placeholder]="'settings.nameSavedState' | translate"
              [pTooltip]="'settings.nameSavedState' | translate"
              tooltipPosition="top"
              required
              [(ngModel)]="editValue"
              (keydown.enter)="clickSaveState()"
            />
            <button
              pButton
              pRipple
              type="button"
              class="p-button-outlined"
              icon="fa-solid fa-floppy-disk"
              [pTooltip]="'settings.saveState' | translate"
              tooltipPosition="top"
              [disabled]="nameCtrl.invalid"
              (click)="clickSaveState()"
            ></button>
            <button
              pButton
              pRipple
              type="button"
              class="p-button-outlined"
              icon="fa-solid fa-xmark"
              [pTooltip]="'cancel' | translate"
              (click)="editState = null"
            ></button>
          </div>
        } @else if (savedStates().length) {
          <div class="p-inputgroup">
            <p-dropdown
              [placeholder]="'settings.selectSavedState' | translate"
              [pTooltip]="'settings.selectSavedState' | translate"
              tooltipPosition="top"
              [ngModel]="state"
              [options]="savedStates()"
              (onChange)="setState($event.value, gameStates())"
            ></p-dropdown>
            @if (state) {
              <button
                pButton
                pRipple
                type="button"
                class="p-button-outlined"
                icon="fa-solid fa-ellipsis-vertical"
                (click)="stateMenu.toggle($event)"
              >
                <p-menu
                  #stateMenu
                  appendTo="body"
                  [popup]="true"
                  [model]="editStateMenu"
                >
                  <ng-template pTemplate="item" let-item>
                    <a pRipple class="p-menuitem-link">
                      <span
                        class="p-menuitem-icon"
                        [ngClass]="item.icon"
                      ></span>
                      <span class="p-menuitem-text">{{
                        item.label | translate
                      }}</span>
                    </a>
                  </ng-template>
                </p-menu>
              </button>
            } @else {
              <button
                pButton
                pRipple
                type="button"
                class="p-button-outlined"
                icon="fa-solid fa-plus"
                [pTooltip]="'settings.createSavedState' | translate"
                (click)="openCreateState()"
              ></button>
            }
          </div>
        } @else {
          <button
            pButton
            pRipple
            type="button"
            icon="fa-solid fa-plus"
            class="p-button-outlined p-button-rounded w-100"
            [label]="'settings.createSavedState' | translate"
            (click)="openCreateState()"
          ></button>
        }
      </p-accordionTab>
      <p-accordionTab>
        <ng-template pTemplate="header">
          <div
            class="d-flex align-items-center justify-content-between flex-grow-1"
          >
            <div>{{ 'settings.game' | translate }}</div>
            <div>
              @if (modId(); as modId) {
                {{ modId }}
              }
            </div>
          </div>
        </ng-template>
        <div class="p-fluid">
          <div class="mt-3" [class.pb-3]="data().flags.has('mods')">
            <span class="p-float-label">
              <p-dropdown
                labDropdownTranslate
                inputId="game"
                [pTooltip]="'settings.gameTooltip' | translate"
                [ngModel]="data().game"
                [options]="gameOptions"
                (onChange)="setGame($event.value)"
              >
              </p-dropdown>
              <label for="game">{{ 'settings.game' | translate }}</label>
              @if (!data().flags.has('mods')) {
                @for (mod of data().version | keyvalue; track mod.key) {
                  <small class="position-absolute end-0 bottom-100 me-1 mb-1">
                    {{ mod.value }}
                  </small>
                }
              }
            </span>
          </div>
          @if (data().flags.has('mods')) {
            <div class="position-relative">
              <label for="mod" class="p-static-label">{{
                'settings.modSet' | translate
              }}</label>
              <small class="position-absolute end-0 top-0 me-1 mb-1">
                <a
                  href="https://github.com/factoriolab/factoriolab/issues/new?assignees=&labels=mod+support&template=mod-request.md&title="
                  target="_blank"
                  >{{ 'settings.requestMod' | translate }}</a
                >
              </small>
              <span class="p-inputgroup">
                <p-dropdown
                  inputId="mod"
                  styleClass="w-100"
                  [filter]="true"
                  [autofocusFilter]="!contentSvc.isMobile()"
                  [pTooltip]="'settings.modSetTooltip' | translate"
                  [ngModel]="settings().modId"
                  [options]="modOptions()"
                  (onChange)="setMod($event.value)"
                >
                </p-dropdown>
                <button
                  pButton
                  pRipple
                  icon="fa-solid fa-info"
                  class="p-button-outlined"
                  [pTooltip]="'settings.modVersions' | translate"
                  (click)="versionsVisible = true"
                >
                  <p-dialog
                    [(visible)]="versionsVisible"
                    appendTo="body"
                    [modal]="true"
                    [dismissableMask]="true"
                    [draggable]="false"
                    [resizable]="false"
                    [style]="{ width: '400px', maxHeight: '500px' }"
                    [breakpoints]="{ '400px': '100vw' }"
                    [header]="'settings.modVersions' | translate"
                  >
                    <p-table
                      responsiveLayout="scroll"
                      styleClass="p-datatable-sm"
                      [value]="data().version | keyvalue"
                    >
                      <ng-template pTemplate="header">
                        <tr>
                          <th>{{ 'settings.mod' | translate }}</th>
                          <th>{{ 'settings.version' | translate }}</th>
                        </tr>
                      </ng-template>
                      <ng-template pTemplate="body" let-mod>
                        <tr>
                          <td>{{ mod.key }}</td>
                          <td>{{ mod.value }}</td>
                        </tr>
                      </ng-template>
                    </p-table>
                    <ng-template pTemplate="footer">
                      <button
                        pButton
                        pRipple
                        type="button"
                        class="p-button-outlined"
                        icon="fa-solid fa-check"
                        [label]="'ok' | translate"
                        (click)="versionsVisible = false"
                      ></button>
                    </ng-template>
                  </p-dialog>
                </button>
              </span>
            </div>
          }
          <div class="mt-3 pb-3">
            <button
              pButton
              pRipple
              type="button"
              class="p-button-rounded p-button-outlined"
              icon="fa-solid fa-microchip"
              [pTooltip]="'settings.techsTooltip' | translate"
              [label]="
                settings().researchedTechnologyIds
                  ? ('settings.techsResearched'
                    | translate
                      : {
                          count: settings().researchedTechnologyIds.size,
                        })
                  : ('settings.allTechsResearched' | translate)
              "
              (click)="techPicker.clickOpen(settings().researchedTechnologyIds)"
            ></button>
            <lab-tech-picker
              #techPicker
              (selectIds)="
                settingsSvc.apply({ researchedTechnologyIds: $event })
              "
            ></lab-tech-picker>
          </div>
          <div class="pb-3">
            <button
              pButton
              pRipple
              type="button"
              class="p-button-rounded p-button-outlined"
              icon="fa-solid fa-flask-vial"
              [pTooltip]="'settings.recipesTooltip' | translate"
              [label]="
                'settings.recipesExcluded'
                  | translate
                    : {
                        count: settings().excludedRecipeIds.size,
                      }
              "
              (click)="
                recipesPicker.clickOpen(
                  'recipe',
                  data().recipeIds,
                  settings().excludedRecipeIds
                )
              "
            ></button>
            <lab-picker
              #recipesPicker
              [header]="'settings.recipesHeader' | translate"
              (selectIds)="
                settingsSvc.updateField(
                  'excludedRecipeIds',
                  $event,
                  settings().defaultExcludedRecipeIds
                )
              "
            ></lab-picker>
          </div>
          <div>
            <button
              pButton
              pRipple
              type="button"
              class="p-button-rounded p-button-outlined"
              icon="fa-solid fa-boxes-stacked"
              [pTooltip]="'settings.itemsTooltip' | translate"
              [label]="
                'settings.itemsExcluded'
                  | translate
                    : {
                        count: settings().excludedItemIds.size,
                      }
              "
              (click)="
                itemsPicker.clickOpen(
                  'item',
                  data().itemIds,
                  settings().excludedItemIds
                )
              "
            ></button>
            <lab-picker
              #itemsPicker
              [header]="'settings.itemsHeader' | translate"
              (selectIds)="settingsSvc.apply({ excludedItemIds: $event })"
            ></lab-picker>
          </div>
        </div>
      </p-accordionTab>
      <p-accordionTab [selected]="true">
        <ng-template pTemplate="header">
          <div
            class="d-flex align-items-center justify-content-between flex-grow-1"
          >
            <div>{{ 'settings.factory' | translate }}</div>
            @if (presetDropdown.label(); as label) {
              <div>{{ label | translate }}</div>
            }
          </div>
        </ng-template>
        <div class="p-fluid">
          <div class="mt-3 pb-3">
            <span class="p-float-label">
              <p-dropdown
                #presetDropdown
                labDropdownTranslate
                inputId="preset"
                [pTooltip]="'settings.presetTooltip' | translate"
                [ngModel]="settings().preset"
                [options]="presetOptions()"
                (onChange)="settingsSvc.apply({ preset: $event.value })"
              >
              </p-dropdown>
              <label for="preset">{{ 'settings.preset' | translate }}</label>
            </span>
          </div>
          @if (options().locations.length) {
            <div class="pb-3">
              <label class="p-static-label" for="locations">{{
                'settings.locations' | translate
              }}</label>
              <p-multiSelect
                #locationsSelect
                inputId="locations"
                styleClass="icons"
                appendTo="body"
                scrollHeight="40vh"
                panelStyleClass="tooltip"
                [pTooltip]="'settings.locationsTooltip' | translate"
                [ngModel]="settings().locationIds | toArray"
                [options]="options().locations"
                (onPanelHide)="changeLocations(locationsSelect.value)"
              >
                <ng-template pTemplate="selectedItems" let-items>
                  <div class="d-flex">
                    @for (location of items; track location; let i = $index) {
                      <i
                        class="mx-2"
                        [class]="location | iconSmClass: 'location'"
                      ></i>
                    }
                  </div>
                </ng-template>
                <ng-template pTemplate="item" let-item>
                  <div
                    class="d-flex align-items-center p-2 w-100 h-100"
                    [pTooltip]="data().locationEntities[item.value].name"
                  >
                    <i [class]="item.value | iconSmClass: 'location'"></i>
                    <div class="ms-3 text-truncate">
                      {{ item.label }}
                    </div>
                  </div>
                </ng-template>
              </p-multiSelect>
            </div>
          }
          @if (options().modules.length) {
            <div class="pb-3">
              <label class="p-static-label" for="modifier-rank">{{
                'settings.modifierRank' | translate
              }}</label>
              <p-multiSelect
                inputId="modifier-rank"
                styleClass="icons"
                appendTo="body"
                scrollHeight="40vh"
                panelStyleClass="tooltip"
                [pTooltip]="'settings.modifierRankTooltip' | translate"
                [ngModel]="settings().moduleRankIds"
                [options]="options().modules"
                (onChange)="
                  settingsSvc.updateField(
                    'moduleRankIds',
                    $event.value,
                    settings().defaultModuleRankIds
                  )
                "
              >
                <ng-template pTemplate="selectedItems" let-items>
                  <div class="d-flex">
                    @for (item of items; track item; let i = $index) {
                      <i class="mx-2" [class]="item | iconSmClass"></i>
                    }
                  </div>
                </ng-template>
                <ng-template pTemplate="item" let-item>
                  <div
                    class="d-flex align-items-center p-2 w-100 h-100"
                    [pTooltip]="tooltip"
                  >
                    <i [class]="item.value | iconSmClass"></i>
                    <div class="ms-3 text-truncate">
                      {{ item.label }}
                    </div>
                    <ng-template #tooltip>
                      <lab-tooltip
                        [id]="item.value"
                        type="module"
                      ></lab-tooltip>
                    </ng-template>
                  </div>
                </ng-template>
              </p-multiSelect>
            </div>
          }
          @if (data().flags.has('fuels')) {
            <div class="pb-3">
              <label class="p-static-label" for="fuel-rank">{{
                'settings.fuelRank' | translate
              }}</label>
              <p-multiSelect
                inputId="fuel-rank"
                styleClass="icons"
                appendTo="body"
                scrollHeight="40vh"
                panelStyleClass="tooltip"
                [pTooltip]="'settings.fuelRankTooltip' | translate"
                [ngModel]="settings().fuelRankIds"
                [options]="options().fuels"
                (onChange)="
                  settingsSvc.updateField(
                    'fuelRankIds',
                    $event.value,
                    settings().defaultFuelRankIds
                  )
                "
              >
                <ng-template pTemplate="selectedItems" let-items>
                  <div class="d-flex">
                    @for (item of items; track item; let i = $index) {
                      <i class="mx-2" [class]="item | iconSmClass"></i>
                    }
                  </div>
                </ng-template>
                <ng-template pTemplate="item" let-item>
                  <div
                    class="d-flex align-items-center p-2 w-100 h-100"
                    [pTooltip]="tooltip"
                  >
                    <i [class]="item.value | iconSmClass"></i>
                    <div class="ms-3 text-truncate">
                      {{ item.label }}
                    </div>
                    <ng-template #tooltip>
                      <lab-tooltip [id]="item.value" type="fuel"></lab-tooltip>
                    </ng-template>
                  </div>
                </ng-template>
              </p-multiSelect>
            </div>
          }
          @if (!data().flags.has('hideMachineSettings')) {
            <div class="p-inputgroup flex-wrap machine-preference mb-1">
              <span
                class="p-inputgroup-addon icon-width"
                [pTooltip]="'settings.machineDefaults' | translate"
              >
                <i class="fa-solid fa-industry"></i>
              </span>
              <p-dropdown
                labDropdownBase="icon"
                [class.invisible]="!options().machines.length"
                [ngModel]="options().machines[0]?.value"
                [pTooltip]="'settings.addMachineTooltip' | translate"
                [options]="options().machines | filterOptions: machineIds()"
                (onChange)="addMachine($event.value)"
              >
                <ng-template pTemplate="selectedItem" let-item>
                  <div
                    class="d-flex align-items-center justify-content-center h-100"
                  >
                    <i class="fa-solid fa-plus"></i>
                  </div>
                </ng-template>
                <ng-template pTemplate="item" let-item>
                  <div
                    class="d-flex align-items-center py-2 w-100 h-100"
                    [pTooltip]="tooltip"
                  >
                    <i [class]="item.value | iconSmClass"></i>
                    <div class="ms-3 text-truncate">
                      {{ item.label }}
                    </div>
                    <ng-template #tooltip>
                      <lab-tooltip
                        [id]="item.value"
                        type="machine"
                      ></lab-tooltip>
                    </ng-template>
                  </div>
                </ng-template>
              </p-dropdown>
              @if (data().flags.has('overclock')) {
                <p-inputNumber
                  #overclockInput
                  labNoDrag
                  suffix="%"
                  [min]="1"
                  [max]="250"
                  [step]="10"
                  [maxFractionDigits]="2"
                  [showButtons]="true"
                  incrementButtonClass="p-button-outlined"
                  decrementButtonClass="p-button-outlined"
                  inputStyleClass="text-end"
                  [pTooltip]="'settings.overclockTooltip' | translate"
                  [ngModel]="settings().overclock?.toNumber()"
                  (onBlur)="
                    settingsSvc.apply({
                      overclock: rational(overclockInput.value ?? 100),
                    })
                  "
                >
                </p-inputNumber>
              }
              @if (
                data().flags.has('beacons') && settings().beacons;
                as beacons
              ) {
                @if (beacons.length) {
                  <button
                    pButton
                    pRipple
                    type="button"
                    class="hover-action icons p-button-text flex-column"
                    [pTooltip]="tooltip"
                    (click)="beaconsOverlay.show($event, beacons)"
                  >
                    @for (beacon of beacons; track $index) {
                      <div class="d-flex">
                        <i
                          class="p-button-icon"
                          [class]="beacon.id | iconSmClass"
                          ><span>{{ beacon.count }}</span></i
                        >
                        @for (module of beacon.modules; track module.id) {
                          <i
                            class="p-button-icon"
                            [class]="module.id | iconSmClass"
                            ><span>{{ module.count }}</span></i
                          >
                        }
                      </div>
                    }
                    <i class="hover-icon fa-solid fa-gear"></i>
                  </button>
                  <lab-beacons-overlay
                    #beaconsOverlay
                    (setValue)="changeDefaultBeacons($event)"
                  ></lab-beacons-overlay>
                  <ng-template #tooltip>
                    @if (beacons?.[0]?.id; as beaconId) {
                      <lab-tooltip [id]="beaconId" type="beacon"></lab-tooltip>
                    }
                  </ng-template>
                }
              }
            </div>
            <p-orderList
              [value]="machineIds()"
              [dragdrop]="true"
              (onReorder)="
                settingsSvc.updateField(
                  'machineRankIds',
                  machineIds(),
                  settings().defaultMachineRankIds
                )
              "
            >
              <ng-template pTemplate="item" let-machineId>
                @if (machinesState()[machineId]; as ms) {
                  @if (data().machineEntities[machineId]; as machine) {
                    <div class="p-inputgroup flex-wrap machine-preference">
                      <button
                        pButton
                        pRipple
                        type="button"
                        class="p-button-outlined cursor-grab"
                        icon="fa-solid fa-grip-lines"
                      ></button>
                      <p-dropdown
                        labDropdownBase="icon"
                        labNoDrag
                        [pTooltip]="'settings.machineTooltip' | translate"
                        [ngModel]="machineId"
                        [options]="
                          options().machines
                            | filterOptions: machineIds() : machineId
                        "
                        (onChange)="setMachine(machineId, $event.value)"
                      >
                        <ng-template pTemplate="selectedItem" let-item>
                          <div class="d-flex">
                            <i [class]="machineId | iconSmClass"></i>
                          </div>
                        </ng-template>
                        <ng-template pTemplate="item" let-item>
                          <div
                            class="d-flex align-items-center py-2 w-100 h-100"
                            [pTooltip]="tooltip"
                          >
                            <i [class]="item.value | iconSmClass"></i>
                            <div class="ms-3 text-truncate">
                              {{ item.label }}
                            </div>
                            <ng-template #tooltip>
                              <lab-tooltip
                                [id]="item.value"
                                type="machine"
                              ></lab-tooltip>
                            </ng-template>
                          </div>
                        </ng-template>
                      </p-dropdown>
                      @if (ms.fuelId) {
                        <p-dropdown
                          labDropdownBase="icon"
                          labNoDrag
                          [pTooltip]="'settings.fuelTooltip' | translate"
                          [ngModel]="ms.fuelId"
                          [options]="ms.fuelOptions"
                          (onChange)="
                            machinesSvc.updateEntityField(
                              machineId,
                              'fuelId',
                              $event.value,
                              ms.defaultFuelId
                            )
                          "
                        >
                          <ng-template pTemplate="selectedItem" let-item>
                            <div class="d-flex">
                              <i [class]="item.value | iconSmClass"></i>
                            </div>
                          </ng-template>
                          <ng-template pTemplate="item" let-item>
                            <div
                              class="d-flex align-items-center py-2 w-100 h-100"
                              [pTooltip]="tooltip"
                            >
                              <i [class]="item.value | iconSmClass"></i>
                              <div class="ms-3 text-truncate">
                                {{ item.label }}
                              </div>
                              <ng-template #tooltip>
                                <lab-tooltip
                                  [id]="item.value"
                                  type="fuel"
                                ></lab-tooltip>
                              </ng-template>
                            </div>
                          </ng-template>
                        </p-dropdown>
                      }
                      @if (ms.modules && machine.modules) {
                        @if (
                          machine.modules !== true && machine.modules?.isOne()
                        ) {
                          <p-dropdown
                            labDropdownBase="icon"
                            labNoDrag
                            [pTooltip]="'settings.modifierTooltip' | translate"
                            [ngModel]="ms.modules[0].id"
                            [options]="ms.moduleOptions ?? []"
                            (onChange)="
                              changeModules(machineId, [
                                { id: $event.value, count: rational.one },
                              ])
                            "
                          >
                            <ng-template pTemplate="selectedItem" let-item>
                              <div class="d-flex">
                                <i [class]="item.value | iconSmClass"></i>
                              </div>
                            </ng-template>
                            <ng-template pTemplate="item" let-item>
                              <div
                                class="d-flex align-items-center py-2 w-100 h-100"
                                [pTooltip]="
                                  item.value !== 'module' ? tooltip : undefined
                                "
                              >
                                <i [class]="item.value | iconSmClass"></i>
                                <div class="ms-3 text-truncate">
                                  {{ item.label }}
                                </div>
                                <ng-template #tooltip>
                                  <lab-tooltip
                                    [id]="item.value"
                                    type="module"
                                  ></lab-tooltip>
                                </ng-template>
                              </div>
                            </ng-template>
                          </p-dropdown>
                        } @else {
                          <button
                            pButton
                            pRipple
                            type="button"
                            class="hover-action icons p-button-text"
                            [pTooltip]="tooltip"
                            (click)="
                              modulesOverlay.show($event, ms.modules, machine)
                            "
                          >
                            @for (module of ms.modules; track module.id) {
                              <i
                                class="p-button-icon"
                                [class]="module.id | iconSmClass"
                                ><span>{{ module.count }}</span></i
                              >
                            }
                            <i class="hover-icon fa-solid fa-gear"></i>
                          </button>
                          <lab-modules-overlay
                            #modulesOverlay
                            (setValue)="changeModules(machineId, $event)"
                          ></lab-modules-overlay>
                          <ng-template #tooltip>
                            @for (module of ms.modules; track module.id) {
                              @if (module.id) {
                                <lab-tooltip
                                  [id]="module.id"
                                  type="module"
                                ></lab-tooltip>
                              }
                            }
                          </ng-template>
                        }
                      }
                      <!-- Overclock input -->
                      @if (data().flags.has('overclock')) {
                        <p-inputNumber
                          #overclockInput
                          labNoDrag
                          suffix="%"
                          [min]="1"
                          [max]="250"
                          [step]="10"
                          [maxFractionDigits]="2"
                          [showButtons]="true"
                          incrementButtonClass="p-button-outlined"
                          decrementButtonClass="p-button-outlined"
                          inputStyleClass="text-end"
                          [pTooltip]="'settings.overclockTooltip' | translate"
                          [ngModel]="ms.overclock?.toNumber()"
                          (onBlur)="
                            machinesSvc.updateEntityField(
                              machineId,
                              'overclock',
                              rational(overclockInput.value ?? 100),
                              ms.defaultOverclock
                            )
                          "
                        >
                        </p-inputNumber>
                      }
                      @if (ms.beacons && ms.beacons.length) {
                        <button
                          pButton
                          pRipple
                          type="button"
                          class="hover-action icons p-button-text flex-column"
                          [pTooltip]="tooltip"
                          (click)="beaconsOverlay.show($event, ms.beacons)"
                        >
                          @for (beacon of ms.beacons; track $index) {
                            <div class="d-flex">
                              <i
                                class="p-button-icon"
                                [class]="beacon.id | iconSmClass"
                                ><span>{{ beacon.count }}</span></i
                              >
                              @for (module of beacon.modules; track module.id) {
                                <i
                                  class="p-button-icon"
                                  [class]="module.id | iconSmClass"
                                  ><span>{{ module.count }}</span></i
                                >
                              }
                            </div>
                          }
                          <i class="hover-icon fa-solid fa-gear"></i>
                        </button>
                        <lab-beacons-overlay
                          #beaconsOverlay
                          (setValue)="changeBeacons(machineId, $event)"
                        ></lab-beacons-overlay>
                        <ng-template #tooltip>
                          @if (ms.beacons?.[0]?.id; as beaconId) {
                            <lab-tooltip
                              [id]="beaconId"
                              type="beacon"
                            ></lab-tooltip>
                          }
                        </ng-template>
                      }
                      <button
                        pButton
                        pRipple
                        labNoDrag
                        type="button"
                        icon="fa-solid fa-xmark"
                        class="p-button-outlined ms-auto"
                        [class.invisible]="machineId === ''"
                        [pTooltip]="
                          'settings.removeMachinePreference' | translate
                        "
                        (click)="removeMachine(machineId)"
                      ></button>
                    </div>
                  }
                }
              </ng-template>
            </p-orderList>
            <div class="pt-2"><!--spacer--></div>
          }
          @if (data().flags.has('beacons')) {
            <div class="pb-3">
              <p-checkbox
                [ngModel]="settings().beaconReceivers != null"
                [binary]="true"
                [label]="'settings.estimateBeaconPowerUsage' | translate"
                [pTooltip]="
                  'settings.estimateBeaconPowerUsageTooltip' | translate
                "
                tooltipPosition="bottom"
                (onChange)="toggleBeaconReceivers($event.checked)"
              ></p-checkbox>
            </div>
          }
          @if (settings().beaconReceivers; as beaconReceivers) {
            <div class="pb-3">
              <label class="p-static-label" for="beacon-receivers">{{
                'settings.averageBeaconReceivers' | translate
              }}</label>
              <lab-input-number
                inputId="beacon-receivers"
                class="w-100"
                [pTooltip]="
                  'settings.averageBeaconReceiversTooltip' | translate
                "
                [value]="beaconReceivers"
                (setValue)="settingsSvc.apply({ beaconReceivers: $event })"
              ></lab-input-number>
            </div>
          }
          @if (data().flags.has('proliferator')) {
            <div class="mt-3 pb-3">
              <div class="p-float-label">
                <p-dropdown
                  labDropdownBase
                  inputId="proliferator-self-spray"
                  [autoDisplayFirst]="false"
                  [pTooltip]="
                    'settings.proliferatorSelfSprayTooltip' | translate
                  "
                  [ngModel]="settings().proliferatorSprayId"
                  [options]="options().proliferatorModules"
                  (onChange)="
                    settingsSvc.apply({ proliferatorSprayId: $event.value })
                  "
                >
                  <ng-template pTemplate="selectedItem" let-item>
                    <div class="d-flex align-items-center h-100">
                      <i [class]="item.value | iconSmClass"></i>
                      <div class="ms-3 text-truncate">
                        {{ item.label }}
                      </div>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-item>
                    <div
                      class="d-flex align-items-center py-2 w-100 h-100"
                      [pTooltip]="item.value !== 'module' ? tooltip : undefined"
                    >
                      <i [class]="item.value | iconSmClass"></i>
                      <div class="ms-3 text-truncate">
                        {{ item.label }}
                      </div>
                      <ng-template #tooltip>
                        <lab-tooltip
                          [id]="item.value"
                          type="module"
                        ></lab-tooltip>
                      </ng-template>
                    </div>
                  </ng-template>
                </p-dropdown>
                <label for="proliferator-self-spray">{{
                  'settings.proliferatorSelfSpray' | translate
                }}</label>
              </div>
            </div>
          }
          <div class="mt-3 pb-3">
            <div class="p-float-label">
              <p-dropdown
                labDropdownBase
                inputId="default-transport-belt"
                [pTooltip]="'settings.defaultTransportBeltTooltip' | translate"
                [ngModel]="settings().beltId"
                [options]="options().belts"
                (onChange)="
                  settingsSvc.updateField(
                    'beltId',
                    $event.value,
                    settings().defaultBeltId
                  )
                "
              >
                <ng-template pTemplate="selectedItem" let-item>
                  @if (item) {
                    <div class="d-flex align-items-center h-100">
                      <i [class]="item.value | iconSmClass"></i>
                      <div class="ms-3 text-truncate">
                        {{ item.label }}
                      </div>
                    </div>
                  }
                </ng-template>
                <ng-template pTemplate="item" let-item>
                  <div
                    class="d-flex align-items-center py-2 w-100 h-100"
                    [pTooltip]="tooltip"
                  >
                    <i [class]="item.value | iconSmClass"></i>
                    <div class="ms-3 text-truncate">
                      {{ item.label }}
                    </div>
                    <ng-template #tooltip>
                      <lab-tooltip [id]="item.value" type="belt"></lab-tooltip>
                    </ng-template>
                  </div>
                </ng-template>
              </p-dropdown>
              <label for="default-transport-belt">{{
                'settings.defaultTransportBelt' | translate
              }}</label>
            </div>
          </div>
          @if (data().flags.has('beltStack')) {
            <div class="pb-3">
              <label class="p-static-label" for="stack">{{
                'settings.defaultStack' | translate
              }}</label>
              <lab-input-number
                inputId="stack"
                class="w-100"
                [pTooltip]="'settings.defaultStackTooltip' | translate"
                [value]="settings().stack ?? rational.one"
                [minimum]="rational.one"
                (setValue)="settingsSvc.apply({ stack: $event })"
              ></lab-input-number>
            </div>
          }
          @if (options().pipes.length > 1) {
            <div class="mt-3 pb-3">
              <div class="p-float-label">
                <p-dropdown
                  labDropdownBase
                  inputId="default-pipe"
                  [pTooltip]="'settings.defaultPipeTooltip' | translate"
                  [ngModel]="settings().pipeId"
                  [options]="options().pipes"
                  (onChange)="
                    settingsSvc.updateField(
                      'pipeId',
                      $event.value,
                      settings().defaultPipeId
                    )
                  "
                >
                  <ng-template pTemplate="selectedItem" let-item>
                    <div class="d-flex align-items-center h-100">
                      <i [class]="item.value | iconSmClass"></i>
                      <div class="ms-3 text-truncate">
                        {{ item.label }}
                      </div>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-item>
                    <div
                      class="d-flex align-items-center py-2 w-100 h-100"
                      [pTooltip]="tooltip"
                    >
                      <i [class]="item.value | iconSmClass"></i>
                      <div class="ms-3 text-truncate">
                        {{ item.label }}
                      </div>
                      <ng-template #tooltip>
                        <lab-tooltip
                          [id]="item.value"
                          type="pipe"
                        ></lab-tooltip>
                      </ng-template>
                    </div>
                  </ng-template>
                </p-dropdown>
                <label for="default-pipe">{{
                  'settings.defaultPipe' | translate
                }}</label>
              </div>
            </div>
          }
          @if (options().cargoWagons.length > 1) {
            <div class="mt-3 pb-3">
              <div class="p-float-label">
                <p-dropdown
                  labDropdownBase
                  inputId="default-cargo-wagon"
                  [pTooltip]="'settings.defaultCargoWagonTooltip' | translate"
                  [ngModel]="settings().cargoWagonId"
                  [options]="options().cargoWagons"
                  (onChange)="
                    settingsSvc.updateField(
                      'cargoWagonId',
                      $event.value,
                      settings().defaultCargoWagonId
                    )
                  "
                >
                  <ng-template pTemplate="selectedItem" let-item>
                    <div class="d-flex align-items-center h-100">
                      <i [class]="item.value | iconSmClass"></i>
                      <div class="ms-3 text-truncate">
                        {{ item.label }}
                      </div>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-item>
                    <div
                      class="d-flex align-items-center py-2 w-100 h-100"
                      [pTooltip]="tooltip"
                    >
                      <i [class]="item.value | iconSmClass"></i>
                      <div class="ms-3 text-truncate">
                        {{ item.label }}
                      </div>
                      <ng-template #tooltip>
                        <lab-tooltip
                          [id]="item.value"
                          type="cargo-wagon"
                        ></lab-tooltip>
                      </ng-template>
                    </div>
                  </ng-template>
                </p-dropdown>
                <label for="default-cargo-wagon">{{
                  'settings.defaultCargoWagon' | translate
                }}</label>
              </div>
            </div>
          }
          @if (options().fluidWagons.length > 1) {
            <div class="mt-3 pb-3">
              <div class="p-float-label">
                <p-dropdown
                  labDropdownBase
                  inputId="default-fluid-wagon"
                  [pTooltip]="'settings.defaultFluidWagonTooltip' | translate"
                  [ngModel]="settings().fluidWagonId"
                  [options]="options().fluidWagons"
                  (onChange)="
                    settingsSvc.updateField(
                      'fluidWagonId',
                      $event.value,
                      settings().defaultFluidWagonId
                    )
                  "
                >
                  <ng-template pTemplate="selectedItem" let-item>
                    <div class="d-flex align-items-center h-100">
                      <i [class]="item.value | iconSmClass"></i>
                      <div class="ms-3 text-truncate">
                        {{ item.label }}
                      </div>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="item" let-item>
                    <div
                      class="d-flex align-items-center py-2 w-100 h-100"
                      [pTooltip]="tooltip"
                    >
                      <i [class]="item.value | iconSmClass"></i>
                      <div class="ms-3 text-truncate">
                        {{ item.label }}
                      </div>
                      <ng-template #tooltip>
                        <lab-tooltip
                          [id]="item.value"
                          type="fluid-wagon"
                        ></lab-tooltip>
                      </ng-template>
                    </div>
                  </ng-template>
                </p-dropdown>
                <label for="default-fluid-wagon">{{
                  'settings.defaultFluidWagon' | translate
                }}</label>
              </div>
            </div>
          }
          @if (data().flags.has('flowRate')) {
            <div class="mt-3 pb-3">
              <div class="p-float-label">
                <p-inputNumber
                  #flowRateInput
                  inputId="pipe-flow-rate"
                  [suffix]="' ' + ('settings.flowRateUnit' | translate)"
                  [min]="1"
                  [step]="100"
                  [showButtons]="true"
                  incrementButtonClass="p-button-outlined"
                  decrementButtonClass="p-button-outlined"
                  [pTooltip]="'settings.pipeFlowRateTooltip' | translate"
                  [ngModel]="settings().flowRate.toNumber()"
                  (onBlur)="
                    settingsSvc.apply({
                      flowRate: rational(flowRateInput.value ?? 1200),
                    })
                  "
                ></p-inputNumber>
                <label for="pipe-flow-rate">{{
                  'settings.pipeFlowRate' | translate
                }}</label>
                <small class="position-absolute end-0 bottom-100 me-1 mb-1">
                  <a
                    href="https://wiki.factorio.com/Fluid_system#Pipelines"
                    target="_blank"
                    >{{ 'settings.wiki' | translate }}</a
                  >
                </small>
              </div>
            </div>
          }
          @if (data().flags.has('inserterEstimation')) {
            <div class="mt-3">
              <div class="p-float-label">
                <p-dropdown
                  labDropdownTranslate
                  inputId="inserter-target"
                  [pTooltip]="'settings.inserterTargetTooltip' | translate"
                  [ngModel]="settings().inserterTarget"
                  [options]="inserterTargetOptions"
                  (onChange)="
                    settingsSvc.apply({ inserterTarget: $event.value })
                  "
                >
                </p-dropdown>
                <label for="inserter-target">{{
                  'settings.inserterTarget' | translate
                }}</label>
              </div>
            </div>
          }
        </div>
      </p-accordionTab>
      @if (
        data().flags.has('inserterEstimation') ||
        data().flags.has('miningSpeed') ||
        data().flags.has('miningProductivity') ||
        data().flags.has('researchSpeed') ||
        data().prodUpgradeTechs.length
      ) {
        <p-accordionTab [header]="'settings.bonuses' | translate">
          <div class="p-fluid">
            @if (data().flags.has('miningSpeed')) {
              <div class="mt-3 pb-3">
                <div class="p-float-label">
                  <p-inputNumber
                    #miningBonusInput
                    inputId="mining-speed"
                    suffix="%"
                    [min]="100"
                    [step]="10"
                    [showButtons]="true"
                    incrementButtonClass="p-button-outlined"
                    decrementButtonClass="p-button-outlined"
                    [pTooltip]="'settings.miningSpeedTooltip' | translate"
                    [ngModel]="
                      settings().miningBonus.add(rational(100)).toNumber()
                    "
                    (onInput)="
                      settingsSvc.apply({
                        miningBonus: rational(
                          (miningBonusInput.value ?? 100) - 100
                        ),
                      })
                    "
                  ></p-inputNumber>
                  <label for="mining-speed">{{
                    'settings.miningSpeed' | translate
                  }}</label>
                </div>
              </div>
            }
            @if (data().flags.has('miningProductivity')) {
              <div class="mt-3 pb-3">
                <div class="p-float-label">
                  <p-inputNumber
                    #miningProdInput
                    inputId="mining-productivity"
                    prefix="+"
                    suffix="%"
                    [min]="0"
                    [step]="10"
                    [showButtons]="true"
                    incrementButtonClass="p-button-outlined"
                    decrementButtonClass="p-button-outlined"
                    [pTooltip]="
                      'settings.miningProductivityTooltip' | translate
                    "
                    [ngModel]="settings().miningBonus.toNumber()"
                    (onBlur)="
                      settingsSvc.apply({
                        miningBonus: rational(miningProdInput.value ?? 0),
                      })
                    "
                  ></p-inputNumber>
                  <label for="mining-productivity">{{
                    'settings.miningProductivity' | translate
                  }}</label>
                </div>
              </div>
            }
            @if (data().flags.has('researchSpeed')) {
              <div class="mt-3 pb-3">
                <div class="p-float-label">
                  <p-dropdown
                    labDropdownTranslate
                    inputId="research-bonus"
                    [pTooltip]="'settings.researchSpeedTooltip' | translate"
                    [ngModel]="settings().researchBonus"
                    [options]="researchSpeedOptions"
                    (onChange)="
                      settingsSvc.apply({ researchBonus: $event.value })
                    "
                  >
                  </p-dropdown>
                  <label for="research-speed">{{
                    'settings.researchSpeed' | translate
                  }}</label>
                </div>
              </div>
            }
            @if (data().flags.has('inserterEstimation')) {
              <div class="mt-3 pb-3">
                <div class="p-float-label">
                  <p-dropdown
                    labDropdownTranslate
                    inputId="inserter-capacity"
                    [pTooltip]="'settings.inserterCapacityTooltip' | translate"
                    [ngModel]="settings().inserterCapacity"
                    [options]="inserterCapacityOptions"
                    (onChange)="
                      settingsSvc.apply({ inserterCapacity: $event.value })
                    "
                  >
                  </p-dropdown>
                  <label for="inserter-capacity">{{
                    'settings.inserterCapacity' | translate
                  }}</label>
                </div>
              </div>
            }
            @if (data().prodUpgradeTechs.length) {
              <div class="pb-3">
                <button
                  pButton
                  pRipple
                  type="button"
                  class="p-button-rounded p-button-outlined"
                  icon="fa-solid fa-flask-vial"
                  [pTooltip]="'settings.recipeProductivityTooltip' | translate"
                  [label]="'settings.recipeProductivity' | translate"
                  (click)="recipeProdDlg.open()"
                >
                  <lab-recipe-productivity
                    #recipeProdDlg
                  ></lab-recipe-productivity>
                </button>
              </div>
            }
          </div>
        </p-accordionTab>
      }
      <p-accordionTab [header]="'settings.display' | translate">
        <div class="p-fluid">
          <div class="mt-3 pb-3">
            <span class="p-float-label">
              <p-dropdown
                labDropdownTranslate
                inputId="display-rate"
                [pTooltip]="'settings.displayRateTooltip' | translate"
                [ngModel]="settings().displayRate"
                [options]="displayRateOptions"
                (onChange)="settingsSvc.apply({ displayRate: $event.value })"
              >
              </p-dropdown>
              <label for="display-rate">{{
                'settings.displayRate' | translate
              }}</label>
            </span>
          </div>
          @if (columnsState().power.show) {
            <div class="mt-3 pb-3">
              <span class="p-float-label">
                <p-dropdown
                  labDropdownTranslate
                  inputId="power-unit"
                  [pTooltip]="'settings.powerUnitTooltip' | translate"
                  [ngModel]="preferences().powerUnit"
                  [options]="powerUnitOptions"
                  (onChange)="preferencesSvc.apply({ powerUnit: $event.value })"
                >
                </p-dropdown>
                <label for="power-unit">{{
                  'settings.powerUnit' | translate
                }}</label>
              </span>
            </div>
          }
          <div class="mt-3 pb-3">
            <div class="text-end"></div>
            <div class="p-float-label">
              <p-dropdown
                labDropdownTranslate
                inputId="language"
                [pTooltip]="'settings.languageTooltip' | translate"
                [ngModel]="preferences().language"
                [options]="languageOptions"
                (onChange)="preferencesSvc.apply({ language: $event.value })"
              >
              </p-dropdown>
              <label for="language">{{
                'settings.language' | translate
              }}</label>
              <small class="position-absolute end-0 bottom-100 me-1 mb-1">
                <a
                  href="https://github.com/factoriolab/factoriolab/wiki/Translating-FactorioLab"
                  target="_blank"
                  >{{ 'settings.helpTranslate' | translate }}</a
                >
              </small>
            </div>
          </div>
          <div class="mt-3 pb-3">
            <div class="p-float-label">
              <p-dropdown
                labDropdownTranslate
                inputId="theme"
                [pTooltip]="'settings.themeTooltip' | translate"
                [ngModel]="preferences().theme"
                [options]="themeOptions"
                (onChange)="preferencesSvc.apply({ theme: $event.value })"
              >
              </p-dropdown>
              <label for="theme">{{ 'settings.theme' | translate }}</label>
            </div>
          </div>
          <div class="pb-3">
            <p-checkbox
              [binary]="true"
              [label]="'settings.bypassLanding' | translate"
              [ngModel]="preferences().bypassLanding"
              (onChange)="
                preferencesSvc.apply({ bypassLanding: $event.checked })
              "
            ></p-checkbox>
          </div>
          <div class="pb-3">
            <p-checkbox
              [ngModel]="preferences().hideDuplicateIcons"
              [binary]="true"
              [label]="'settings.hideDuplicateIcons' | translate"
              (onChange)="
                preferencesSvc.apply({ hideDuplicateIcons: $event.checked })
              "
            ></p-checkbox>
          </div>
          <div>
            <p-checkbox
              [ngModel]="preferences().disablePaginator"
              [binary]="true"
              [label]="'settings.disablePaginator' | translate"
              (onChange)="
                preferencesSvc.apply({ disablePaginator: $event.checked })
              "
            ></p-checkbox>
          </div>
        </div>
      </p-accordionTab>
      <p-accordionTab [header]="'settings.advanced' | translate">
        <div class="p-fluid">
          <div class="mt-3 pb-3">
            <span class="p-float-label">
              <p-dropdown
                labDropdownTranslate
                inputId="maximize-type"
                [pTooltip]="'settings.maximizeTypeTooltip' | translate"
                [ngModel]="settings().maximizeType"
                [options]="maximizeTypeOptions"
                (onChange)="settingsSvc.apply({ maximizeType: $event.value })"
              >
              </p-dropdown>
              <label for="maximize-type">{{
                'settings.maximizeType' | translate
              }}</label>
            </span>
          </div>
          <div class="pb-3">
            <p-checkbox
              [ngModel]="settings().netProductionOnly"
              [binary]="true"
              [label]="'settings.netProductionOnly' | translate"
              [pTooltip]="'settings.netProductionOnlyTooltip' | translate"
              tooltipPosition="top"
              (onChange)="
                settingsSvc.apply({ netProductionOnly: $event.checked })
              "
            ></p-checkbox>
          </div>
          <div class="pb-3">
            <p-checkbox
              [ngModel]="settings().requireMachinesOutput"
              [binary]="true"
              [label]="'settings.requireMachinesOutput' | translate"
              [pTooltip]="'settings.requireMachinesOutputTooltip' | translate"
              tooltipPosition="top"
              (onChange)="
                settingsSvc.apply({ requireMachinesOutput: $event.checked })
              "
            ></p-checkbox>
          </div>
          <div class="pb-3">
            <p-checkbox
              [ngModel]="preferences().convertObjectiveValues"
              [binary]="true"
              [label]="'settings.convertObjectiveValues' | translate"
              [pTooltip]="'settings.convertObjectiveValuesTooltip' | translate"
              tooltipPosition="top"
              (onChange)="
                preferencesSvc.apply({ convertObjectiveValues: $event.checked })
              "
            ></p-checkbox>
          </div>
          <button
            pButton
            pRipple
            type="button"
            class="p-button-rounded p-button-outlined mb-4"
            icon="fa-solid fa-dollar-sign"
            [label]="'settings.openCosts' | translate"
            (click)="costsDlg.open(settings().costs)"
          ></button>
        </div>
      </p-accordionTab>
    </p-accordion>
  </p-scrollPanel>
</div>
<lab-costs #costsDlg></lab-costs>
